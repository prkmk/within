<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Within - A mindful toolkit: Timer, Habits, and Calm Down">
    <title>Within</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23ffd050'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%231a1a1a'/%3E%3Ccircle cx='90' cy='90' r='60' fill='%23ffd050'/%3E%3C/svg%3E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Within">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --accent: #ffd050;
            --accent2: #ff8d1b;
            --danger: #ff5050;
            --text: #f5f5f5;
            --text2: #a0a0a0;
            --border: #2a2a2a;
            --dim: 0.4;
            --radius: 1.125rem / 1rem;
            --xs: 0.5rem;
            --sm: 0.75rem;
            --md: 1rem;
            --lg: 1.5rem;
            --xl: 2rem;
            --gap: 0.75rem;
            --pad: 1.5rem;
            --h: 4rem;
            --line: 0.125rem;
            --line2: 0.25rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'IBM Plex Mono', monospace; background: var(--bg-primary); color: var(--text); min-height: 100vh; padding-bottom: var(--h); }

        .page { display: none; padding: var(--pad); max-width: 500px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(1rem); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-family: 'Fraunces', serif; font-size: var(--xl); font-weight: 400; font-style: italic; margin-bottom: var(--pad); letter-spacing: -0.02em; }
        h2 { font-family: 'Fraunces', serif; font-size: var(--lg); font-weight: 500; font-style: italic; margin-bottom: var(--gap); letter-spacing: -0.02em; }
        p { font-family: 'Fraunces', serif; font-size: var(--md); font-weight: 500; letter-spacing: 0.15em; }

        label { display: block; font-size: var(--sm); text-transform: uppercase; letter-spacing: 0.15em; color: var(--text2); margin-bottom: var(--gap); font-weight: 500; }

        .input-row { display: flex; gap: var(--gap); }
        .input-group { margin-bottom: var(--pad); flex: 1; }

        .input-group input { width: 100%; background: var(--bg-secondary); border: var(--line) solid var(--border); border-radius: var(--radius); color: var(--text); font-family: 'Fraunces', serif; font-size: var(--lg); font-weight: 600; height: var(--h); padding: 0 var(--gap); outline: none; transition: border-color 0.2s; }
        .input-group input:focus { border-color: var(--accent); }
        .input-group input::placeholder { color: var(--text2); font-weight: 300; }

        /* Steppers */
        .stepper-wrapper { display: flex; align-items: center; background: var(--bg-secondary); border-radius: var(--radius); border: var(--line) solid var(--border); overflow: hidden; }
        .stepper-btn { flex: 0 0 auto; width: calc(var(--h) - 2 * var(--line)); height: calc(var(--h) - 2 * var(--line)); background: none; color: var(--text); border: none; cursor: pointer; transition: transform 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 0; }
        .stepper-btn:disabled { color: var(--text2); cursor: not-allowed; opacity: var(--dim); }
        .stepper-btn:hover:not(:disabled) { transform: scale(1.05); }
        .stepper-btn:active:not(:disabled) { transform: scale(0.95); }
        .stepper-value { flex: 1; text-align: center; font-family: 'Fraunces', serif; font-size: var(--xl); font-weight: 600; min-width: var(--h); }
        .select-btn { flex: 0 0 auto; width: 50%; height: calc(var(--h) - 2 * var(--line)); background: none; color: var(--text2); border: none; font-family: 'Fraunces', serif; font-size: var(--lg); font-weight: 600; cursor: pointer; transition: transform 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 0; }
        .select-btn:disabled { cursor: not-allowed; opacity: var(--dim); }
        .select-btn:hover { transform: scale(1.05); }
        .select-btn:active { transform: scale(0.95); }
        .selected { color: var(--accent); }

        /* Timer */
        .circular-timer { display: flex; align-items: center; justify-content: center; margin: var(--pad) 0; }
        .circle-container { position: relative; width: 450px; height: 450px; }
        .circle-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .circle-segment { fill: none; stroke: var(--accent); stroke-width: var(--line); stroke-linecap: round; }
        .position-marker { fill: var(--accent2); transition: cx 0.1s linear, cy 0.1s linear; }
        .center-controls { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: var(--gap); z-index: 10; }

        /* Buttons */
        button { font-family: 'Fraunces', serif; font-size: var(--md); font-weight: 700; border: none; cursor: pointer; transition: transform 0.2s ease; height: var(--h); min-width: var(--h); border-radius: var(--radius); display: flex; align-items: center; justify-content: center; padding: 0; }
        .btn-svg { width: var(--xl); height: var(--xl); }
        .btn-svg path { fill: currentColor; }
        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-secondary { background: var(--bg-secondary); color: var(--accent); border: var(--line) solid var(--accent); }
        .btn-tertiary { background: none; color: var(--accent); }
        .btn-primary:hover, .btn-secondary:hover, .btn-tertiary:hover { transform: scale(1.05); }
        .btn-primary:active, .btn-secondary:active, .btn-tertiary:active { transform: scale(0.95); }
        .danger.btn-primary { background: var(--danger); }
        .danger.btn-secondary { color: var(--danger); border-color: var(--danger); }
        .wide { width: 100%; }
        .hidden { display: none !important; }

        /* Habits */
        .habits-list { display: flex; flex-direction: column; gap: 12px; }
        .habits-list-and-button { display: flex; flex-direction: column; gap: 12px; }
        .empty-state { padding: var(--pad) 0; text-align: center; }

        .habit-card { background: var(--bg-secondary); border: var(--line) solid var(--border); border-radius: var(--radius); padding: 0 var(--gap); display: flex; height: calc(var(--h) - 2 * var(--line)); align-items: center; gap: var(--gap); cursor: pointer; transition: transform 0.2s ease; user-select: none; }
        .habit-card:active { transform: scale(0.98); }
        .habit-card.state-completed { opacity: var(--dim); cursor: default; }
        .habit-card.state-failed .habit-title,
        .habit-card.state-failed .streak-number { color: var(--danger); }

        .habit-indicator { flex-shrink: 0; width: var(--xl); height: var(--xl); position: relative; display: flex; align-items: center; justify-content: center; }
        .indicator-svg { width: var(--xl); height: var(--xl); }
        .indicator-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: var(--xs); font-weight: 400; color: var(--text2); pointer-events: none; }
        .red { color: var(--danger); }
        .gold { color: var(--accent); }

        .habit-info { flex: 1; min-width: 0; }
        .habit-title { font-family: 'Fraunces', serif; font-size: var(--md); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .habit-meta { font-size: var(--sm); color: var(--text2); text-transform: uppercase; letter-spacing: 0.1em; }
        .habit-streak { flex-shrink: 0; display: flex; flex-direction: column; align-items: flex-end; padding-right: var(--gap); }
        .streak-number { font-family: 'Fraunces', serif; font-size: var(--md); font-weight: 600; line-height: 1; }
        .streak-unit { font-size: var(--sm); color: var(--text2); text-transform: uppercase; letter-spacing: 0.1em; }

        /* Context menu */
        .context-menu { position: fixed; background: var(--bg-secondary); border-radius: var(--radius); border: var(--line) solid var(--border); z-index: 1000; min-width: 160px; animation: popIn 0.15s ease; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
        .context-menu-item { width: 100%; padding: var(--gap) var(--md); background: none; border: none; color: var(--text); font-family: 'IBM Plex Mono', monospace; font-size: var(--md); font-weight: 500; letter-spacing: 0.05em; cursor: pointer; display: flex; gap: var(--gap); min-height: unset; justify-content: flex-start; transition: transform 0.15s ease; }
        .context-menu-item:hover { transform: scale(1.05); }
        .context-menu-item:active { transform: scale(0.95); }
        .context-menu-item.red { color: var(--danger); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; display: flex; align-items: center; justify-content: center; padding: var(--pad); animation: popIn 0.15s ease; }
        .modal-overlay.hidden { display: none !important; }
        .modal-content { background: var(--bg-secondary); border: var(--line) solid var(--border); border-radius: var(--radius); padding: var(--pad); width: 100%; max-width: calc(500px - 2 * var(--pad)); }
        .actions { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .delete-preview { margin-bottom: var(--pad); }
        .delete-preview .habit-card { cursor: default; pointer-events: none; }

        #habitSaveBtn:disabled { opacity: var(--dim); cursor: not-allowed; transform: none !important; pointer-events: none; }

        /* Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: var(--bg-primary); z-index: 100; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: var(--h); cursor: pointer; transition: transform 0.2s ease; border: none; background: transparent; color: var(--text2); text-transform: uppercase; font-size: var(--sm); letter-spacing: 0.1em; }
        .nav-item:active { transform: scale(0.95); }
        .nav-item.active { color: var(--accent); }

        /* Calm Down */
        .breath-container { position: relative; display: flex; align-items: center; justify-content: center; min-height: 450px; }
        .breath-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: var(--sm); height: var(--sm); border-radius: 50%; background: var(--accent); filter: blur(var(--xl)); opacity: var(--dim); }
        .breath-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; gap: var(--pad); }
        .breath-phase { font-family: 'Fraunces', serif; font-size: var(--xl); font-weight: 300; font-style: italic; text-align: center; }
        .breath-dots { display: flex; gap: var(--sm); align-items: center; justify-content: center; }
        .breath-dot { width: var(--sm); height: var(--sm); border-radius: 50%; border: var(--line) solid var(--border); background: transparent; transition: all 0.3s ease; }
        .breath-dot.active { background: var(--accent); border-color: var(--accent); }
    </style>
</head>
<body>

<!-- Timer Page -->
<div class="page active" id="timerPage">
    <h1>Timer</h1>
    <div class="input-row">
        <div class="input-group">
            <label>Cycle (minutes)</label>
            <div class="stepper-wrapper">
                <button class="stepper-btn" id="timerCycleMinus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/></svg></button>
                <div class="stepper-value" id="timerCycleValue">10</div>
                <button class="stepper-btn" id="timerCyclePlus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/></svg></button>
            </div>
        </div>
        <div class="input-group">
            <label>Divisions</label>
            <div class="stepper-wrapper">
                <button class="stepper-btn" id="timerDivMinus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/></svg></button>
                <div class="stepper-value" id="timerDivValue">1</div>
                <button class="stepper-btn" id="timerDivPlus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/></svg></button>
            </div>
        </div>
    </div>
    <div class="input-group">
        <label>Sound Profile</label>
        <div class="stepper-wrapper">
            <button class="select-btn selected" id="soundProfileGong">Gong</button>
            <button class="select-btn" id="soundProfileBowl">Bowl</button>
        </div>
    </div>
    <div class="circular-timer">
        <div class="circle-container">
            <svg class="circle-svg" viewBox="0 0 200 200">
                <g id="circleSegments"></g>
                <circle class="position-marker" id="positionMarker" cx="100" cy="10" r="6"/>
            </svg>
            <div class="center-controls">
                <button class="btn-primary" id="startBtn"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M9.5 6.47331C11 5.60749 13.0002 6.76264 17 9.07195L20 10.8034C23.9997 13.1126 25.9997 14.2678 26 15.9997C26 17.7317 23.9999 18.8866 20 21.196L17 22.9284C13.0001 25.2378 11 26.3921 9.5 25.526C8.00011 24.66 8 22.3508 8 17.7321V14.2682C8 9.64944 8 7.33934 9.5 6.47331Z" fill="currentColor"/></svg></button>
                <button class="btn-primary hidden" id="pauseBtn"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M11 6C12.6569 6 14 7.34315 14 9V23C14 24.6569 12.6569 26 11 26C9.34315 26 8 24.6569 8 23V9C8 7.34315 9.34315 6 11 6Z" fill="currentColor"/><path d="M21 6C22.6569 6 24 7.34315 24 9V23C24 24.6569 22.6569 26 21 26C19.3431 26 18 24.6569 18 23V9C18 7.34315 19.3431 6 21 6Z" fill="currentColor"/></svg></button>
                <button class="btn-secondary danger hidden" id="stopBtn"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 8C19.7712 8 21.6566 8.0003 22.8281 9.17188C23.9997 10.3434 24 12.2288 24 16C24 19.7712 23.9997 21.6566 22.8281 22.8281C21.6566 23.9997 19.7712 24 16 24C12.2288 24 10.3434 23.9997 9.17188 22.8281C8.0003 21.6566 8 19.7712 8 16C8 12.2288 8.0003 10.3434 9.17188 9.17188C10.3434 8.0003 12.2288 8 16 8Z" fill="currentColor"/></svg></button>
                <button class="btn-primary hidden" id="continueBtn"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M9.5 6.47331C11 5.60749 13.0002 6.76264 17 9.07195L20 10.8034C23.9997 13.1126 25.9997 14.2678 26 15.9997C26 17.7317 23.9999 18.8866 20 21.196L17 22.9284C13.0001 25.2378 11 26.3921 9.5 25.526C8.00011 24.66 8 22.3508 8 17.7321V14.2682C8 9.64944 8 7.33934 9.5 6.47331Z" fill="currentColor"/></svg></button>
            </div>
        </div>
    </div>
</div>

<!-- Habits Page -->
<div class="page" id="habitsPage">
    <h1>Habits</h1>
    <div class="habits-list-and-button">
        <div id="habitsList" class="habits-list"></div>
        <div class="empty-state hidden" id="emptyStateHabits">
            <h2>No habits yet</h2>
            <p>Start tracking your first habit</p>
        </div>
        <button class="btn-tertiary wide" id="addHabitBtn">
            <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/></svg>
        </button>
    </div>
</div>

<!-- Add/Edit Habit Modal -->
<div class="modal-overlay hidden" id="habitModal">
    <div class="modal-content">
        <h1 id="habitModalTitle">Add Habit</h1>
        <div class="input-group">
            <label>Name</label>
            <input type="text" id="habitName" placeholder="Read 20 pages" maxlength="50">
        </div>
        <div class="input-group">
            <label>Frequency</label>
            <div class="stepper-wrapper">
                <button class="stepper-btn" id="frequencyMinus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/></svg></button>
                <div class="stepper-value" id="frequencyValue">1</div>
                <button class="stepper-btn" id="frequencyPlus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/></svg></button>
            </div>
        </div>
        <div class="input-group">
            <label>Type</label>
            <div class="stepper-wrapper">
                <button class="select-btn selected" id="dailyBtn">Daily</button>
                <button class="select-btn" id="weeklyBtn">Weekly</button>
            </div>
        </div>
        <div class="actions">
            <button class="btn-tertiary wide" id="habitCancelBtn">Cancel</button>
            <button class="btn-primary wide" id="habitSaveBtn">Save</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay hidden" id="deleteModal">
    <div class="modal-content">
        <h1>Delete Item</h1>
        <div id="deleteModalPreview" class="delete-preview"></div>
        <div class="actions">
            <button class="btn-tertiary wide" id="deleteCancelBtn">Cancel</button>
            <button class="btn-primary danger wide" id="deleteConfirmBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu hidden" id="contextMenu">
    <button class="context-menu-item" id="editHabitBtn">
        <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M21.293 10.707C22.626 12.04 23.2925 12.7072 23.2927 13.5354V13.5354C23.2925 14.3637 22.626 15.0302 21.293 16.3632L10.8277 26.8285C10.2498 27.4064 9.96079 27.6954 9.59334 27.8476V27.8476C9.22587 27.9998 8.8169 27.9999 7.99957 27.9999C6.11437 27.9999 5.17177 27.9999 4.58602 27.4144V27.4144C4.00047 26.8286 4 25.8856 4 24.0004C4 23.183 4 22.7744 4.15218 22.4069V22.4069C4.30442 22.0395 4.59351 21.7502 5.17145 21.1722L15.6367 10.707C16.9698 9.37393 17.6363 8.70741 18.4645 8.70728V8.70728C19.2927 8.70741 19.9599 9.37393 21.293 10.707ZM6.53538 22.6355C6.19258 22.9783 6 23.4432 6 23.928V24.0002C6 25.1046 6.89533 25.9999 7.99979 25.9999H8.0708C8.55571 25.9999 9.02075 25.8073 9.36364 25.4644C10.0776 24.7505 10.0777 23.593 9.36386 22.879L9.12065 22.6357C8.40684 21.9216 7.24931 21.9215 6.53538 22.6355ZM27.1816 7.18158C27.3974 7.39732 27.5053 7.50519 27.5841 7.60752C28.1382 8.32687 28.1382 9.32927 27.5841 10.0486C27.5053 10.1509 27.3974 10.2588 27.1816 10.4746C26.9659 10.6903 26.858 10.7982 26.7557 10.877C26.0364 11.4311 25.034 11.4311 24.3146 10.877C24.2123 10.7982 24.1044 10.6903 23.8887 10.4746L21.5254 8.11127C21.3097 7.89553 21.2018 7.78766 21.1229 7.68533C20.5688 6.96598 20.5688 5.96359 21.1229 5.24424C21.2018 5.14191 21.3097 5.03404 21.5254 4.8183C21.7411 4.60256 21.849 4.49469 21.9513 4.41586C22.6707 3.86171 23.6731 3.86171 24.3924 4.41586C24.4947 4.49469 24.6026 4.60256 24.8184 4.8183L27.1816 7.18158Z" fill="currentColor"/></svg>
        <span>Edit</span>
    </button>
    <button class="context-menu-item red" id="deleteHabitBtn">
        <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M18 5C18 5.55228 18.4477 6 19 6H24.5C25.3284 6 26 6.67157 26 7.5C26 8.32843 25.3284 9 24.5 9H7.5C6.67157 9 6 8.32843 6 7.5C6 6.67157 6.67157 6 7.5 6H13C13.5523 6 14 5.55228 14 5C14 4.44772 14.4477 4 15 4H17C17.5523 4 18 4.44772 18 5Z" fill="currentColor"/><path d="M8.37367 17.3523C8.19843 14.3733 8.11081 12.8838 8.99894 11.9419C9.88707 11 11.3792 11 14.3633 11H17.6367C20.6209 11 22.1129 11 23.0011 11.9419C23.8892 12.8838 23.8016 14.3733 23.6263 17.3523L23.3322 22.3523C23.1748 25.0277 23.0962 26.3654 22.2294 27.1827C21.3626 28 20.0226 28 17.3426 28H14.6574C11.9774 28 10.6374 28 9.77062 27.1827C8.90385 26.3654 8.82516 25.0277 8.66778 22.3523L8.37367 17.3523Z" fill="currentColor"/></svg>
        <span>Delete</span>
    </button>
</div>

<!-- Calm Down Page -->
<div class="page" id="calmPage">
    <h1>Calm Down</h1>
    <div class="input-row">
        <div class="input-group">
            <label>Duration (seconds)</label>
            <div class="stepper-wrapper">
                <button class="stepper-btn" id="breathDurationMinus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/></svg></button>
                <div class="stepper-value" id="breathDurationValue">20</div>
                <button class="stepper-btn" id="breathDurationPlus"><svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/></svg></button>
            </div>
        </div>
    </div>
    <div class="breath-container">
        <div class="breath-circle" id="breathCircle"></div>
        <div class="breath-content">
            <div class="breath-phase" id="breathPhase">Inhale</div>
            <div class="breath-dots" id="breathDots"></div>
        </div>
    </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <button class="nav-item active" data-page="timerPage">
        <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M23.5 9.5C27.0899 9.5 30 12.4101 30 16C30 19.5899 27.0899 22.5 23.5 22.5C20.9095 22.5 18.939 21.2409 17.5605 19.9824C16.9412 19.417 16.4211 18.8317 16 18.3301C15.5789 18.8317 15.0588 19.417 14.4395 19.9824C13.061 21.2409 11.0905 22.5 8.5 22.5C4.91015 22.5 2 19.5899 2 16C2 12.4101 4.91015 9.5 8.5 9.5C11.0905 9.5 13.061 10.7591 14.4395 12.0176C15.0586 12.5828 15.579 13.1675 16 13.6689C16.421 13.1675 16.9414 12.5828 17.5605 12.0176C18.939 10.7591 20.9095 9.5 23.5 9.5ZM8.5 12.5C6.567 12.5 5 14.067 5 16C5 17.933 6.567 19.5 8.5 19.5C10.0516 19.5 11.331 18.759 12.417 17.7676C12.9576 17.2741 13.4243 16.7413 13.833 16.2471C13.898 16.1684 13.9652 16.085 14.0342 16C13.9652 15.915 13.898 15.8316 13.833 15.7529C13.4243 15.2587 12.9576 14.7259 12.417 14.2324C11.331 13.241 10.0516 12.5 8.5 12.5ZM23.5 12.5C21.9484 12.5 20.669 13.241 19.583 14.2324C19.0424 14.7259 18.5757 15.2587 18.167 15.7529C18.1018 15.8317 18.034 15.9148 17.9648 16C18.034 16.0852 18.1018 16.1683 18.167 16.2471C18.5757 16.7413 19.0424 17.2741 19.583 17.7676C20.669 18.759 21.9484 19.5 23.5 19.5C25.433 19.5 27 17.933 27 16C27 14.067 25.433 12.5 23.5 12.5Z" fill="currentColor"/></svg>
        <span>Timer</span>
    </button>
    <button class="nav-item" data-page="habitsPage">
        <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M25.4004 5C25.9579 5 26.2367 5.00042 26.4668 5.05566C27.1981 5.23123 27.7688 5.80191 27.9443 6.5332C27.9996 6.76332 28 7.04206 28 7.59961C28 9.8305 28.0002 10.9466 27.7793 11.8672C27.077 14.7924 24.7924 17.077 21.8672 17.7793C21.0033 17.9866 19.9677 17.9973 18 17.998V25C18 26.1046 17.1046 27 16 27C14.8954 27 14 26.1046 14 25V21.998C12.0323 21.9973 10.9967 21.9866 10.1328 21.7793C7.20762 21.077 4.92298 18.7924 4.2207 15.8672C3.99977 14.9466 4 13.8305 4 11.5996C4 11.0421 4.00042 10.7633 4.05566 10.5332C4.23123 9.80191 4.80191 9.23123 5.5332 9.05566C5.76332 9.00042 6.04206 9 6.59961 9C8.8305 9 9.94657 8.99977 10.8672 9.2207C12.5501 9.62473 14.0203 10.5533 15.0996 11.8252C15.13 11.5758 15.1689 11.3489 15.2207 11.1328C15.923 8.20762 18.2076 5.92298 21.1328 5.2207C22.0534 4.99977 23.1695 5 25.4004 5Z" fill="currentColor"/></svg>
        <span>Habits</span>
    </button>
    <button class="nav-item" data-page="calmPage">
        <svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M18 18C18.5909 18 19.1758 18.1167 19.7217 18.3428C20.2676 18.5689 20.7638 18.9005 21.1816 19.3184C21.5995 19.7362 21.9311 20.2324 22.1572 20.7783C22.3833 21.3242 22.5 21.9091 22.5 22.5C22.5 23.0909 22.3833 23.6758 22.1572 24.2217C21.9311 24.7676 21.5995 25.2638 21.1816 25.6816C20.7638 26.0995 20.2676 26.4311 19.7217 26.6572C19.1758 26.8833 18.5909 27 18 27C17.1716 27 16.5 26.3284 16.5 25.5C16.5 24.6716 17.1716 24 18 24C18.197 24 18.3922 23.9611 18.5742 23.8857C18.7561 23.8104 18.9213 23.6998 19.0605 23.5605C19.1998 23.4213 19.3104 23.2561 19.3857 23.0742C19.4611 22.8922 19.5 22.697 19.5 22.5C19.5 22.303 19.4611 22.1078 19.3857 21.9258C19.3104 21.7439 19.1998 21.5787 19.0605 21.4395C18.9213 21.3002 18.7561 21.1896 18.5742 21.1143C18.3922 21.0389 18.197 21 18 21H5.5C4.67157 21 4 20.3284 4 19.5C4 18.6716 4.67157 18 5.5 18H18Z" fill="currentColor"/><path d="M23.5 14C24.7856 14 26.0424 14.3815 27.1113 15.0957C28.1802 15.8099 29.0129 16.8251 29.5049 18.0127C29.9969 19.2004 30.1258 20.5077 29.875 21.7686C29.6241 23.0292 29.0056 24.1878 28.0967 25.0967C27.5109 25.6824 26.5604 25.6824 25.9746 25.0967C25.3888 24.5109 25.3888 23.5604 25.9746 22.9746C26.4641 22.4851 26.7976 21.8616 26.9326 21.1826C27.0676 20.5037 26.9983 19.7996 26.7334 19.1602C26.4685 18.5208 26.0198 17.9743 25.4443 17.5898C24.8688 17.2053 24.1922 17 23.5 17H3.5C2.67157 17 2 16.3284 2 15.5C2 14.6716 2.67157 14 3.5 14H23.5Z" fill="currentColor"/><path d="M22 4C22.5909 4 23.1758 4.1167 23.7217 4.34277C24.2676 4.56892 24.7638 4.9005 25.1816 5.31836C25.5995 5.73622 25.9311 6.23235 26.1572 6.77832C26.3833 7.32421 26.5 7.90914 26.5 8.5C26.5 9.09086 26.3833 9.67579 26.1572 10.2217C25.9311 10.7676 25.5995 11.2638 25.1816 11.6816C24.7638 12.0995 24.2676 12.4311 23.7217 12.6572C23.1758 12.8833 22.5909 13 22 13H7.5C6.67157 13 6 12.3284 6 11.5C6 10.6716 6.67157 10 7.5 10H22C22.197 10 22.3922 9.96112 22.5742 9.88574C22.7561 9.81036 22.9213 9.69979 23.0605 9.56055C23.1998 9.42131 23.3104 9.25613 23.3857 9.07422C23.4611 8.89223 23.5 8.69698 23.5 8.5C23.5 8.30302 23.4611 8.10777 23.3857 7.92578C23.3104 7.74387 23.1998 7.57869 23.0605 7.43945C22.9213 7.30021 22.7561 7.18964 22.5742 7.11426C22.3922 7.03888 22.197 7 22 7C21.1716 7 20.5 6.32843 20.5 5.5C20.5 4.67157 21.1716 4 22 4Z" fill="currentColor"/></svg>
        <span>Calm Down</span>
    </button>
</nav>

<script>
// ── State ─────────────────────────────────────────────────────────────────────
let audioCtx;
let isRunning = false, isPaused = false;
let breathCycleDuration = 20, breathPhaseTimeout = null;
let startTime, pausedTime = 0, elapsedTime = 0, timerInterval;
let nextSecondaryTime, nextMainTime, mainCycleMs, secondaryIntervalMs;
let timerCycle = 10, timerDiv = 1, soundProfile = 0;

const CYCLE_VALUES = [1,2,3,4,5,6,7,8,9,10,15,20,25,30,35,40,45,50,55,60];
const DIV_VALUES   = [1,2,3,4,5,6,7,8,9,10];

const soundProfiles = [
    [() => playGong(432), () => playGong(339)],
    [() => playSingingBowl(216), () => playSingingBowl(170)]
];

// ── DOM refs ──────────────────────────────────────────────────────────────────
const $ = id => document.getElementById(id);
const timerCycleEl   = $('timerCycleValue');
const timerDivEl     = $('timerDivValue');
const soundGongBtn   = $('soundProfileGong');
const soundBowlBtn   = $('soundProfileBowl');
const startBtn       = $('startBtn');
const pauseBtn       = $('pauseBtn');
const stopBtn        = $('stopBtn');
const continueBtn    = $('continueBtn');
const positionMarker = $('positionMarker');
const circleSegments = $('circleSegments');
const navItems       = document.querySelectorAll('.nav-item');
const pages          = document.querySelectorAll('.page');

// ── Storage adapter ───────────────────────────────────────────────────────────
const store = {
    async get(key) {
        if (typeof window.storage !== 'undefined') {
            try { const r = await window.storage.get(key, false); return r?.value ?? null; } catch { return null; }
        }
        return localStorage.getItem(key);
    },
    set(key, value) {
        if (typeof window.storage !== 'undefined') { window.storage.set(key, value, false).catch(() => {}); }
        else { try { localStorage.setItem(key, value); } catch {} }
    }
};

// ── Settings ──────────────────────────────────────────────────────────────────
function saveSettings() {
    store.set('app_settings', JSON.stringify({
        timerCycle, timerDiv, soundProfile, breathDuration: breathCycleDuration,
        activePage: document.querySelector('.page.active')?.id ?? 'timerPage'
    }));
}

async function loadSettings() {
    try {
        const val = await store.get('app_settings');
        if (!val) return;
        const s = JSON.parse(val);
        if (CYCLE_VALUES.includes(s.timerCycle)) { timerCycle = s.timerCycle; timerCycleEl.textContent = timerCycle; }
        if (DIV_VALUES.includes(s.timerDiv))     { timerDiv   = s.timerDiv;   timerDivEl.textContent   = timerDiv; }
        if (s.soundProfile === 0 || s.soundProfile === 1) { soundProfile = s.soundProfile; refreshSoundBtns(); }
        if (s.breathDuration >= 10 && s.breathDuration <= 30) {
            breathCycleDuration = s.breathDuration;
            $('breathDurationValue').textContent = breathCycleDuration;
        }
        if (s.activePage) {
            pages.forEach(p => p.classList.remove('active'));
            $('habitsList') && ($('habitsList'), void 0); // keeps linter happy
            document.getElementById(s.activePage)?.classList.add('active');
            navItems.forEach(n => n.classList.toggle('active', n.dataset.page === s.activePage));
            if (s.activePage === 'calmPage') setTimeout(startBreathing, 100);
        }
        refreshTimerSteppers(); drawCircleSegments();
    } catch(e) { console.error('loadSettings:', e); }
}

// ── Navigation ────────────────────────────────────────────────────────────────
navItems.forEach(item => {
    item.addEventListener('click', () => {
        const page = item.dataset.page;
        navItems.forEach(n => n.classList.remove('active')); item.classList.add('active');
        pages.forEach(p => p.classList.remove('active')); document.getElementById(page).classList.add('active');
        if (page !== 'calmPage' && breathPhaseTimeout) { clearTimeout(breathPhaseTimeout); breathPhaseTimeout = null; }
        if (page === 'calmPage') setTimeout(startBreathing, 100);
        saveSettings();
    });
});

// ── Timer steppers ────────────────────────────────────────────────────────────
function refreshTimerSteppers() {
    const ci = CYCLE_VALUES.indexOf(timerCycle), di = DIV_VALUES.indexOf(timerDiv), locked = isRunning || isPaused;
    $('timerCycleMinus').disabled = ci === 0 || locked;
    $('timerCyclePlus').disabled  = ci === CYCLE_VALUES.length - 1 || locked;
    $('timerDivMinus').disabled   = di === 0 || locked;
    $('timerDivPlus').disabled    = di === DIV_VALUES.length - 1 || locked;
}

function makeStepperHandler(getArr, getVal, setVal, displayEl, onchange) {
    return delta => {
        const arr = getArr(), i = arr.indexOf(getVal()) + delta;
        if (i < 0 || i >= arr.length) return;
        setVal(arr[i]); displayEl.textContent = arr[i];
        onchange?.(); refreshTimerSteppers(); saveSettings();
    };
}

const stepCycle = makeStepperHandler(() => CYCLE_VALUES, () => timerCycle, v => timerCycle = v, timerCycleEl);
const stepDiv   = makeStepperHandler(() => DIV_VALUES,   () => timerDiv,   v => timerDiv   = v, timerDivEl, drawCircleSegments);

$('timerCyclePlus').addEventListener('click',  () => stepCycle(1));
$('timerCycleMinus').addEventListener('click', () => stepCycle(-1));
$('timerDivPlus').addEventListener('click',    () => stepDiv(1));
$('timerDivMinus').addEventListener('click',   () => stepDiv(-1));

// ── Sound profile ─────────────────────────────────────────────────────────────
function refreshSoundBtns() {
    const locked = isRunning || isPaused;
    soundGongBtn.disabled = soundBowlBtn.disabled = locked;
    soundGongBtn.classList.toggle('selected', soundProfile === 0);
    soundBowlBtn.classList.toggle('selected', soundProfile === 1);
}

soundGongBtn.addEventListener('click', () => { soundProfiles[0][0](); if (soundProfile !== 0) { soundProfile = 0; refreshSoundBtns(); saveSettings(); } });
soundBowlBtn.addEventListener('click', () => { soundProfiles[1][0](); if (soundProfile !== 1) { soundProfile = 1; refreshSoundBtns(); saveSettings(); } });

// ── Circle drawing ────────────────────────────────────────────────────────────
function drawCircleSegments() {
    circleSegments.innerHTML = '';
    const r = 90, cx = 100, cy = 100, gap = 0.15;
    for (let i = 0; i < timerDiv; i++) {
        const sa = (i / timerDiv) * 2 * Math.PI + gap / 2;
        const ea = ((i + 1) / timerDiv) * 2 * Math.PI - gap / 2;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${cx+r*Math.cos(sa)} ${cy+r*Math.sin(sa)} A${r} ${r} 0 ${ea-sa>Math.PI?1:0} 1 ${cx+r*Math.cos(ea)} ${cy+r*Math.sin(ea)}`);
        path.setAttribute('class', 'circle-segment');
        circleSegments.appendChild(path);
    }
}

function updateMarker(progress) {
    const a = progress * 2 * Math.PI;
    positionMarker.setAttribute('cx', 100 + 90 * Math.cos(a));
    positionMarker.setAttribute('cy', 100 + 90 * Math.sin(a));
}

// ── Audio ─────────────────────────────────────────────────────────────────────
function initAudio() { audioCtx ??= new (window.AudioContext || window.webkitAudioContext)(); }

function playGong(base = 600) {
    initAudio(); const now = audioCtx.currentTime;
    const mg = audioCtx.createGain(); mg.gain.setValueAtTime(0.0001, now); mg.gain.linearRampToValueAtTime(0.5, now+0.01); mg.connect(audioCtx.destination);
    [1.0, 0.5, 1.41, 1.93, 2.57, 3.16, 4.07].forEach((r, i) => {
        const f = base * r, d = 4 + Math.random() * 4;
        [[f*1.02, f, 0.4/(i+1)], [f*(1+0.005*Math.random()), null, 0.15/(i+1)]].forEach(([freq, target, amp]) => {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.setValueAtTime(freq, now);
            if (target) o.frequency.exponentialRampToValueAtTime(target, now+0.04);
            g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(amp, now+0.06); g.gain.exponentialRampToValueAtTime(0.0001, now+d);
            o.connect(g); g.connect(mg); o.start(now); o.stop(now+d);
        });
    });
}

function playSingingBowl(base = 220) {
    initAudio(); const now = audioCtx.currentTime;
    const mg = audioCtx.createGain(); mg.gain.setValueAtTime(0.0001, now); mg.gain.linearRampToValueAtTime(0.6, now+0.1); mg.connect(audioCtx.destination);
    [{r:1.0,a:1.0},{r:2.3,a:0.4},{r:3.8,a:0.25},{r:5.4,a:0.15}].forEach(({r, a}) => {
        const f = base * r, d = 6 + Math.random() * 3;
        [[f, a*0.5], [f*1.003, a*0.3]].forEach(([freq, amp]) => {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.setValueAtTime(freq, now);
            g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(amp, now+0.2); g.gain.exponentialRampToValueAtTime(0.0001, now+d);
            o.connect(g); g.connect(mg); o.start(now); o.stop(now+d);
        });
    });
    const lfo = audioCtx.createOscillator(), lg = audioCtx.createGain();
    lfo.frequency.value = 0.2; lg.gain.value = 0.05; lfo.connect(lg); lg.connect(mg.gain); lfo.start(now); lfo.stop(now+10);
}

// ── Timer controls ────────────────────────────────────────────────────────────
function checkBells() {
    const tol = 50;
    const atMain = Math.abs(elapsedTime - nextMainTime) < tol;
    const atSec  = Math.abs(elapsedTime - nextSecondaryTime) < tol;
    if (atMain) { soundProfiles[soundProfile][0](); nextMainTime += mainCycleMs; if (atSec) nextSecondaryTime += secondaryIntervalMs; }
    else if (atSec) { soundProfiles[soundProfile][1](); nextSecondaryTime += secondaryIntervalMs; }
}

function showTimerBtns(...btns) {
    [startBtn, pauseBtn, stopBtn, continueBtn].forEach(b => b.classList.add('hidden'));
    btns.forEach(b => b.classList.remove('hidden'));
}

function tick() { elapsedTime = Date.now() - startTime; updateMarker((elapsedTime % mainCycleMs) / mainCycleMs); checkBells(); }

function startTimer() {
    initAudio();
    mainCycleMs = timerCycle * 60 * 1000; secondaryIntervalMs = mainCycleMs / timerDiv;
    isRunning = true; isPaused = false; startTime = Date.now(); elapsedTime = pausedTime = 0;
    nextMainTime = mainCycleMs; nextSecondaryTime = secondaryIntervalMs;
    refreshTimerSteppers(); refreshSoundBtns(); showTimerBtns(pauseBtn);
    soundProfiles[soundProfile][0]();
    timerInterval = setInterval(tick, 50);
}

function pauseTimer() {
    isRunning = false; isPaused = true; pausedTime = elapsedTime; clearInterval(timerInterval);
    showTimerBtns(stopBtn, continueBtn); refreshTimerSteppers(); refreshSoundBtns();
}

function continueTimer() {
    isRunning = true; isPaused = false; startTime = Date.now() - pausedTime;
    showTimerBtns(pauseBtn); refreshTimerSteppers(); refreshSoundBtns();
    timerInterval = setInterval(tick, 50);
}

function stopTimer() {
    isRunning = false; isPaused = false; clearInterval(timerInterval); elapsedTime = pausedTime = 0;
    showTimerBtns(startBtn); refreshTimerSteppers(); refreshSoundBtns(); updateMarker(0);
}

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', pauseTimer);
continueBtn.addEventListener('click', continueTimer);
stopBtn.addEventListener('click', stopTimer);

refreshTimerSteppers(); drawCircleSegments(); updateMarker(0);

// ── Habits ────────────────────────────────────────────────────────────────────
let habits = [], editingId = null, freqValue = 1, habitType = 'daily';
let longPressTimer = null, menuHabitId = null;

const habitsList      = $('habitsList');
const emptyState      = $('emptyStateHabits');
const habitModal      = $('habitModal');
const habitModalTitle = $('habitModalTitle');
const habitNameEl     = $('habitName');
const habitSaveBtn    = $('habitSaveBtn');
const freqValueEl     = $('frequencyValue');
const freqPlusBtn     = $('frequencyPlus');
const freqMinusBtn    = $('frequencyMinus');
const dailyBtn        = $('dailyBtn');
const weeklyBtn       = $('weeklyBtn');
const contextMenu     = $('contextMenu');
const deleteModal     = $('deleteModal');
const deletePreview   = $('deleteModalPreview');
const deleteConfirmBtn = $('deleteConfirmBtn');

// Period helpers
function today() { return new Date().toISOString().split('T')[0]; }
function mondayOf(date) {
    const d = new Date(date); d.setHours(0,0,0,0);
    const day = d.getDay(); d.setDate(d.getDate() + (day === 0 ? -6 : 1 - day));
    return d.toISOString().split('T')[0];
}
function periodKey(habit)     { return habit.type === 'daily' ? today() : mondayOf(new Date()); }
function prevPeriodKey(habit) {
    if (habit.type === 'daily') { const d = new Date(); d.setDate(d.getDate()-1); return d.toISOString().split('T')[0]; }
    const d = new Date(); d.setDate(d.getDate()-7); return mondayOf(d);
}
function currentCount(habit)  { return habit.completions.find(c => c.date === periodKey(habit))?.count ?? 0; }
function habitState(habit) {
    if (habit.isFailed) return 'failed';
    const n = currentCount(habit), t = habit.timesRequired;
    return n >= t ? 'checked' : n > 0 ? 'partial' : 'unchecked';
}
function shouldFail(habit) {
    if (habit.isFailed || (!habit.streak && !habit.completions.length)) return false;
    const key = periodKey(habit);
    if (habit.completions.some(c => c.date === key)) return false;  // still in current period
    const prev = habit.completions.find(c => c.date === prevPeriodKey(habit));
    return !(prev && prev.count >= habit.timesRequired);
}

// Storage
async function loadHabits() {
    try { const v = await store.get('habits_v3'); if (v) habits = JSON.parse(v); } catch { habits = []; }
    habits.forEach(h => { if (shouldFail(h)) h.isFailed = true; });
    renderHabits();
}
function saveHabits() { store.set('habits_v3', JSON.stringify(habits)); }
let saveTimer = null;
function scheduleSave() { clearTimeout(saveTimer); saveTimer = setTimeout(saveHabits, 300); }
function saveAndRender() { renderHabits(); scheduleSave(); }

// Indicator SVGs
const ICON_FAIL = `<svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path d="M15.0107 2.35186C15.5366 2.42109 16.014 2.69666 16.3369 3.11748C16.6251 3.49316 16.7099 4.0681 16.7363 5.02471C18.6529 5.15323 20.5071 5.78194 22.1113 6.85381C23.9201 8.06246 25.3305 9.7805 26.1631 11.7903C26.9956 13.8003 27.2135 16.0131 26.7891 18.1468C26.3645 20.2803 25.3165 22.2404 23.7783 23.7786C22.24 25.3169 20.2792 26.3649 18.1455 26.7894C16.0119 27.2136 13.7998 26.9958 11.79 26.1634C9.78022 25.3308 8.06216 23.9204 6.85352 22.1116C5.64492 20.3028 5.00006 18.1757 5 16.0003C5 15.1719 5.67157 14.5003 6.5 14.5003C7.32843 14.5003 8 15.1719 8 16.0003C8.00006 17.5824 8.46964 19.1291 9.34863 20.4446C10.2276 21.7601 11.4768 22.7854 12.9385 23.3909C14.4002 23.9964 16.0088 24.1556 17.5605 23.847C19.1123 23.5383 20.5384 22.7763 21.6572 21.6575C22.776 20.5388 23.538 19.1126 23.8467 17.5608C24.1553 16.0092 23.996 14.4004 23.3906 12.9388C22.7851 11.4771 21.7598 10.2279 20.4443 9.34893C19.3332 8.6065 18.0573 8.15653 16.7344 8.03448C16.706 8.95551 16.6189 9.51427 16.3369 9.88213C16.014 10.303 15.5366 10.5785 15.0107 10.6478C14.3377 10.7362 13.5167 10.2626 11.875 9.31475C10.233 8.36676 9.41215 7.89217 9.15234 7.26494C8.94949 6.77497 8.9494 6.22462 9.15234 5.73467C9.41215 5.10747 10.2332 4.63376 11.875 3.68584C13.5167 2.73801 14.3377 2.26344 15.0107 2.35186Z" fill="currentColor"/></svg>`;
const ICON_CHECK = `<svg class="btn-svg" viewBox="0 0 32 32" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M16 2C23.732 2 30 8.26804 30 16C30 23.732 23.732 30 16 30C8.26809 29.9999 2 23.7319 2 16C2.00003 8.2681 8.26811 2.00009 16 2ZM26.1924 10.8428C25.6067 10.2571 24.657 10.2571 24.0713 10.8428L15.9395 18.9746C14.6061 20.308 13.9398 20.9756 13.1113 20.9756C12.283 20.9756 11.6163 20.3087 10.2832 18.9756L8.51465 17.207C7.92891 16.6213 6.97929 16.6213 6.39355 17.207C5.80784 17.7927 5.8079 18.7424 6.39355 19.3281L10.2822 23.2178C11.8443 24.7798 14.3773 24.7797 15.9395 23.2178L26.1924 12.9639C26.7781 12.3781 26.7781 11.4285 26.1924 10.8428Z" fill="currentColor"/></svg>`;

function createIndicator(state, current, total) {
    if (state === 'failed')  return `<div class="habit-indicator red">${ICON_FAIL}</div>`;
    if (state === 'checked') return `<div class="habit-indicator gold">${ICON_CHECK}</div>`;
    const r = 15, circ = 2 * Math.PI * r, offset = circ - (current / total) * circ;
    return `<div class="habit-indicator">
        <svg class="indicator-svg" viewBox="0 0 32 32" style="transform:rotate(-90deg)">
            <circle cx="16" cy="16" r="${r}" fill="none" stroke="var(--border)" stroke-width="2"/>
            ${current > 0 ? `<circle cx="16" cy="16" r="${r}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"/>` : ''}
        </svg>
        ${total > 1 ? `<div class="indicator-text">${current}/${total}</div>` : ''}
    </div>`;
}

function habitCardHTML(habit, interactive = true) {
    const state = habitState(habit), cur = currentCount(habit), tot = habit.timesRequired;
    const daily = habit.type === 'daily';
    const meta  = tot > 1 ? `${tot}X / ${daily ? 'DAY' : 'WEEK'}` : (daily ? 'DAILY' : 'WEEKLY');
    const sc    = state === 'checked' ? 'state-completed' : state === 'failed' ? 'state-failed' : '';
    const events = interactive
        ? `ontouchstart="handleTouchStart(event,'${habit.id}')" ontouchend="handleTouchEnd()" ontouchmove="handleTouchEnd()"
           onmousedown="handleTouchStart(event,'${habit.id}')" onmouseup="handleTouchEnd()" onmouseleave="handleTouchEnd()"
           oncontextmenu="handleContextMenu(event,'${habit.id}')" onclick="handleHabitClick('${habit.id}')"`
        : `style="cursor:default;pointer-events:none;"`;
    return `<div class="habit-card ${sc}" ${events}>
        ${createIndicator(state, cur, tot)}
        <div class="habit-info">
            <div class="habit-title">${habit.name}</div>
            <div class="habit-meta">${meta}</div>
        </div>
        <div class="habit-streak">
            <div class="streak-number">${habit.streak}</div>
            <div class="streak-unit">${daily ? 'DAYS' : 'WEEKS'}</div>
        </div>
    </div>`;
}

function renderHabits() {
    if (!habits.length) { habitsList.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
    emptyState.classList.add('hidden');
    const order = { unchecked: 0, partial: 0, failed: 1, checked: 2 };
    habitsList.innerHTML = [...habits]
        .sort((a, b) => order[habitState(a)] - order[habitState(b)])
        .map(h => habitCardHTML(h, true)).join('');
}

// Interaction handlers
window.handleTouchStart = (event, id) => {
    menuHabitId = id;
    longPressTimer = setTimeout(() => {
        longPressTimer = null;
        const t = event.touches?.[0] ?? event;
        showContextMenu(t.clientX, t.clientY);
    }, 500);
};
window.handleTouchEnd = () => { clearTimeout(longPressTimer); longPressTimer = null; };
window.handleContextMenu = (event, id) => { event.preventDefault(); menuHabitId = id; showContextMenu(event.clientX, event.clientY); };
window.handleHabitClick = id => {
    if (!longPressTimer && !contextMenu.classList.contains('hidden')) return;
    const h = habits.find(h => h.id === id); if (!h) return;
    if (h.isFailed) { openEditModal(h, true); return; }
    if (habitState(h) === 'checked') return;
    markHabit(id);
};

function showContextMenu(x, y) {
    contextMenu.classList.remove('hidden');
    const mw = contextMenu.offsetWidth || 170, mh = contextMenu.offsetHeight || 110;
    contextMenu.style.left = `${Math.max(8, Math.min(x, innerWidth  - mw - 8))}px`;
    contextMenu.style.top  = `${Math.max(8, Math.min(y, innerHeight - mh - 8))}px`;
    setTimeout(() => document.addEventListener('click', closeContextMenu, { once: true }), 50);
}
function closeContextMenu() { contextMenu.classList.add('hidden'); }

function markHabit(id) {
    const h = habits.find(h => h.id === id); if (!h) return;
    const key = periodKey(h);
    let comp = h.completions.find(c => c.date === key);
    if (comp) { comp.count++; } else { h.completions.push({ date: key, count: 1 }); comp = h.completions.at(-1); }
    if (comp.count >= h.timesRequired) { h.streak = (h.streak || 0) + 1; h.isFailed = false; }
    saveAndRender();
}

// Modal helpers
function updateFreqBtns() { freqMinusBtn.disabled = freqValue <= 1; freqPlusBtn.disabled = freqValue >= 10; }
function updateSaveBtn()  { habitSaveBtn.disabled = !habitNameEl.value.trim(); }

function openAddModal() {
    editingId = null; habitModalTitle.textContent = 'Add Habit';
    habitNameEl.value = ''; freqValue = 1; freqValueEl.textContent = '1';
    habitType = 'daily'; dailyBtn.classList.add('selected'); weeklyBtn.classList.remove('selected');
    updateFreqBtns(); updateSaveBtn();
    habitModal.classList.remove('hidden'); setTimeout(() => habitNameEl.focus(), 100);
}

function openEditModal(habit, isReset) {
    editingId = habit.id; habitModalTitle.textContent = isReset ? 'Reset Habit' : 'Edit Habit';
    habitNameEl.value = habit.name; freqValue = habit.timesRequired; freqValueEl.textContent = freqValue;
    habitType = habit.type;
    dailyBtn.classList.toggle('selected',  habit.type === 'daily');
    weeklyBtn.classList.toggle('selected', habit.type === 'weekly');
    updateFreqBtns(); updateSaveBtn();
    habitModal.classList.remove('hidden');
}

function closeModal(el) { el.classList.add('hidden'); }

// Habit modal events
$('addHabitBtn').addEventListener('click', openAddModal);
$('habitCancelBtn').addEventListener('click', () => closeModal(habitModal));
habitModal.addEventListener('click', e => { if (e.target === habitModal) closeModal(habitModal); });
habitNameEl.addEventListener('input', updateSaveBtn);

freqPlusBtn.addEventListener('click', () => { if (freqValue < 10) { freqValue++; freqValueEl.textContent = freqValue; updateFreqBtns(); } });
freqMinusBtn.addEventListener('click', () => { if (freqValue > 1) { freqValue--; freqValueEl.textContent = freqValue; updateFreqBtns(); } });

dailyBtn.addEventListener('click',  () => { habitType = 'daily';  dailyBtn.classList.add('selected');  weeklyBtn.classList.remove('selected'); });
weeklyBtn.addEventListener('click', () => { habitType = 'weekly'; weeklyBtn.classList.add('selected'); dailyBtn.classList.remove('selected'); });

habitSaveBtn.addEventListener('click', () => {
    const name = habitNameEl.value.trim(); if (!name) return;
    const entry = { name, type: habitType, timesRequired: freqValue, completions: [], streak: 0, isFailed: false };
    if (editingId) {
        const i = habits.findIndex(h => h.id === editingId);
        if (i !== -1) habits[i] = { id: editingId, ...entry };
    } else {
        habits.push({ id: Date.now().toString(), ...entry });
    }
    closeModal(habitModal); saveAndRender();
});

// Context menu events
$('editHabitBtn').addEventListener('click', () => {
    const h = habits.find(h => h.id === menuHabitId); if (h) { openEditModal(h, false); closeContextMenu(); }
});
$('deleteHabitBtn').addEventListener('click', () => {
    const h = habits.find(h => h.id === menuHabitId); if (!h) return;
    closeContextMenu();
    deletePreview.innerHTML = habitCardHTML(h, false);
    deleteConfirmBtn.dataset.habitId = h.id;
    deleteModal.classList.remove('hidden');
});

$('deleteCancelBtn').addEventListener('click', () => closeModal(deleteModal));
deleteModal.addEventListener('click', e => { if (e.target === deleteModal) closeModal(deleteModal); });
deleteConfirmBtn.addEventListener('click', () => {
    habits = habits.filter(h => h.id !== deleteConfirmBtn.dataset.habitId);
    closeModal(deleteModal); saveAndRender();
});

// Init + visibility
loadHabits();
loadSettings();
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        habits.forEach(h => { if (shouldFail(h)) h.isFailed = true; });
        renderHabits();
    }
});

// ── Calm Down ─────────────────────────────────────────────────────────────────
const breathCircle = $('breathCircle');
const breathPhaseEl = $('breathPhase');
const breathDotsEl  = $('breathDots');
const breathDurEl   = $('breathDurationValue');

function refreshBreathBtns() {
    $('breathDurationMinus').disabled = breathCycleDuration <= 10;
    $('breathDurationPlus').disabled  = breathCycleDuration >= 30;
}
$('breathDurationPlus').addEventListener('click',  () => { if (breathCycleDuration < 30) { breathCycleDuration++; breathDurEl.textContent = breathCycleDuration; refreshBreathBtns(); saveSettings(); } });
$('breathDurationMinus').addEventListener('click', () => { if (breathCycleDuration > 10) { breathCycleDuration--; breathDurEl.textContent = breathCycleDuration; refreshBreathBtns(); saveSettings(); } });
refreshBreathBtns();

function makeDots(n) {
    breathDotsEl.innerHTML = Array.from({length: n}, () => '<div class="breath-dot"></div>').join('');
}

function animateCircle(target, dur) {
    const start = parseFloat(breathCircle.style.width) || 10, t0 = performance.now();
    const step = t => {
        const p = Math.min((t - t0) / (dur * 1000), 1), s = start + (target - start) * p;
        breathCircle.style.width = breathCircle.style.height = `${s}px`;
        if (p < 1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
}

function activateDots(n, dur) {
    const dots = breathDotsEl.querySelectorAll('.breath-dot');
    dots.forEach(d => d.classList.remove('active'));
    let i = 0;
    const iv = setInterval(() => { if (i < dots.length) dots[i++].classList.add('active'); else clearInterval(iv); }, (dur * 1000) / n);
}

function startBreathing() {
    breathCircle.style.width = breathCircle.style.height = '10px';
    runBreathCycle();
}

function runBreathCycle() {
    const ud = breathCycleDuration / 19;
    const phases = [
        { label: 'Inhale', dots: 4, size: 300  },
        { label: 'Hold',   dots: 7, size: null  },
        { label: 'Exhale', dots: 8, size: 10    },
    ];
    let i = 0;
    function next() {
        const { label, dots, size } = phases[i];
        breathPhaseEl.textContent = label;
        makeDots(dots);
        activateDots(dots, ud * dots);
        if (size !== null) animateCircle(size, ud * dots);
        i++;
        breathPhaseTimeout = setTimeout(i < phases.length ? next : runBreathCycle, ud * dots * 1000);
    }
    next();
}

// ── Service Worker ────────────────────────────────────────────────────────────
if ('serviceWorker' in navigator) {
    const sw = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>e.waitUntil(clients.claim()));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw], { type: 'application/javascript' })));
}
</script>
</body>
</html>
