<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Within - A mindful toolkit: Timer, Habits, and Calm Down">
    <title>Within</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23ffd050'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%231a1a1a'/%3E%3Ccircle cx='90' cy='90' r='60' fill='%23ffd050'/%3E%3C/svg%3E">
    
    <!-- Apple-specific PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Within">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --accent-primary: #ffd050;
            --accent-secondary: #ff8D1B;
            --danger: #ff5050;
            --blue: #505FFF;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --border: #2a2a2a;
            --disabled-opacity: 0.4;
            --radius: 1.125rem / 1rem;
            --text-xs: 0.5rem;
            --text-sm: 0.75rem;
            --text-md: 1rem;
            --text-lg: 1.5rem;
            --text-xl: 2rem;
            --padding-sm: 0.75rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --button-height: 4rem;
            --line-sm: 0.125rem;
            --line-md: 0.25rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: var(--button-height);
            /* background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 208, 80, 0.2) 0%, transparent 100%),
                radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.2) 0%, transparent 100%),
                radial-gradient(circle at 40% 60%, rgba(68, 61, 252, 0.2) 0%, transparent 100%); */
        }

        .page {
            display: none;
            padding: var(--padding-lg);
            max-width: 500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(1rem); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: var(--text-xl);
            font-weight: 400;
            font-style: italic;
            margin-bottom: var(--padding-lg);
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        h2 {
            font-family: 'Fraunces', serif;
            font-size: var(--text-lg);
            font-weight: 500;
            font-style: italic;
            margin-bottom: var(--padding-sm);
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        p {
            font-size: var(--text-md);
            font-family: 'Fraunces', serif;
            letter-spacing: 0.15em;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-row {
            display: flex;
            gap: var(--padding-sm);
        }
        
        .input-group {
            margin-bottom: var(--padding-lg);
            flex: 1;
        }

        .input-group input {
            width: 100%;
            background: var(--bg-secondary);
            border: var(--line-sm) solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-family: 'Fraunces', serif;
            font-size: var(--text-lg);
            font-weight: 600;
            height: var(--button-height);
            padding: 0 var(--padding-sm);
            outline: none;
            transition: border-color 0.2s;
        }
        .input-group input:focus { border-color: var(--accent-primary); }
        .input-group input::placeholder { color: var(--text-secondary); font-weight: 300; }

        label {
            display: block;
            font-size: var(--text-sm);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            margin-bottom: var(--padding-sm);
            font-weight: 500;
        }

        .stepper-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: var(--line-sm) solid var(--border);
            overflow: hidden;
        }

        .stepper-btn {
            flex: 0 0 auto;
            width: calc(var(--button-height) - 2 * var(--line-sm));
            height: calc(var(--button-height) - 2 * var(--line-sm));
            background: none;
            color: var(--text-primary);
            border: none;
            font-size: var(--text-xl);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: 300;
        }

        .stepper-btn:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: var(--disabled-opacity);
        }

        .stepper-value {
            flex: 1;
            text-align: center;
            font-family: 'Fraunces', serif;
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
            padding: var(--padding-sm) auto;
            min-width: var(--button-height);
        }

        .select-btn {
            flex: 0 0 auto;
            width: 50%;
            height: calc(var(--button-height) - 2 * var(--line-sm));
            background: none;
            color: var(--text-secondary);
            border: none;
            font-family: 'Fraunces', serif;
            font-size: var(--text-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .selected { color: var(--accent-primary); }

        .select-btn:disabled {
            cursor: not-allowed;
            opacity: var(--disabled-opacity);
        }

        .circular-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: var(--padding-lg) 0;
        }

        .circle-container {
            position: relative;
            width: 450px;
            height: 450px;
        }

        .circle-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .circle-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: var(--line-sm);
        }

        .circle-segment {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: var(--line-sm);
            stroke-linecap: round;
        }

        .position-marker {
            fill: var(--accent-secondary);
            transition: cx 0.1s linear, cy 0.1s linear;
        }

        .center-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: var(--padding-sm);
            z-index: 10;
        }

        button {
            /* font-family: 'IBM Plex Mono', monospace; */
            font-family: 'Fraunces', serif;
            font-size: var(--text-md);
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            height: var(--button-height);
            min-width: var(--button-height);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .btn-svg {
            width: var(--text-xl);
            height: var(--text-xl);
        }

        .btn-svg path {
            fill: currentColor;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover, .btn-secondary:hover, .btn-tertiary:hover, .btn-danger:hover, .stepper-btn:hover:not(:disabled), .select-btn:hover, .context-menu-item:hover {
            transform: scale(1.05);
        }

        .btn-primary:active, .btn-secondary:active, .btn-tertiary:active, .btn-danger:active, .stepper-btn:active:not(:disabled), .select-btn:active, .context-menu-item:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--accent-primary);
            border: var(--line-sm) solid var(--accent-primary);
        }
        
        .btn-tertiary {
            background: none;
            color: var(--accent-primary);
        }

        .wide { width: 100%; }

        .btn-primary.danger {
            background: var(--danger);
        }

        .btn-secondary.danger {
            color: var(--danger);
            border: var(--line-sm) solid var(--danger);
        }

        .hidden {
            display: none !important;
        }

        /* Habits Page Styles */
        .habits-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .habits-list-and-button {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .habit-card {
            background: var(--bg-secondary);
            border: var(--line-sm) solid var(--border);
            border-radius: var(--radius);
            padding: 0 var(--padding-sm);
            display: flex;
            height: calc(var(--button-height) - 2 * var(--line-sm));
            align-items: center;
            justify-content: center;
            gap: var(--padding-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
        }

        .habit-card:active {
            transform: scale(0.98);
        }

        .habit-card.completed-today {
            opacity: var(--disabled-opacity);
            pointer-events: none;
        }

        .habit-card.broken {
            opacity: 0.7;
        }

        .habit-progress {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            position: relative;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: var(--line-md);
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: var(--line-md);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .restart-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            color: var(--accent-secondary);
        }

        .habit-info {
            flex: 1;
            min-width: 0;
        }

        .habit-title {
            font-family: 'Fraunces', serif;
            font-size: var(--text-md);
            font-weight: 600;
            color: var(--text-primary);
            /* margin-bottom: 4px; */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .habit-meta {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .habit-streak {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding-right: var(--padding-sm);
            /* gap: 4px; */
        }

        .streak-number {
            font-family: 'Fraunces', serif;
            font-size: var(--text-md);
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        .streak-unit {
            font-size: var(--text-sm);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .streak-icon {
            width: 24px;
            height: 24px;
            margin-top: 4px;
        }

        .empty-state {
            padding: var(--padding-lg) 0;
            text-align: center;
        }


        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: var(--line-sm) solid var(--border);
            padding: 0;
            z-index: 1000;
            min-width: 160px;
            animation: menuPop 0.15s ease;
        }

        @keyframes menuPop {
            from { opacity: 0; transform: scale(0.92); }
            to { opacity: 1; transform: scale(1); }
        }

        .context-menu-item {
            width: 100%;
            padding: var(--padding-sm) var(--padding-md);
            background: none;
            border: none;
            color: var(--text-primary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: var(--text-md);
            font-weight: 500;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: background 0.15s ease;
            display: flex;
            gap: var(--padding-sm);
            min-height: unset;
            justify-content: flex-start;
        }

        .actions {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        /* Calm Down Page Styles */

        .breath-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 450px;
        }

        .breath-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: var(--text-sm);
            height: var(--text-sm);
            border-radius: 50%;
            background: var(--accent-primary);
            filter: blur(var(--text-xl));
            opacity: var(--disabled-opacity);
            transition: width 0.05s linear, height 0.05s linear;
        }

        .breath-content {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--padding-lg);
        }

        .breath-phase {
            font-family: 'Fraunces', serif;
            font-size: var(--text-xl);
            font-weight: 300;
            font-style: italic;
            color: var(--text-primary);
            text-align: center;
        }

        .breath-dots {
            display: flex;
            gap: var(--text-sm);
            align-items: center;
            justify-content: center;
        }

        .breath-dot {
            width: var(--text-sm);
            height: var(--text-sm);
            border-radius: 50%;
            border: var(--line-sm) solid var(--border);
            background: transparent;
            transition: all 0.3s ease;
        }

        .breath-dot.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: var(--bg-primary);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: var(--button-height);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: var(--text-sm);
            letter-spacing: 0.1em;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-icon {
            width: var(--text-lg);
            height: var(--text-lg);
        }

        .nav-icon path {
            transition: fill 0.2s ease;
        }

        /* Add Habit FAB */
        .add-habit-fab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid var(--accent-primary);
            color: var(--accent-primary);
            font-size: 2rem;
            font-weight: 300;
            /* margin: 8px auto 80px; */
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-habit-fab:hover { transform: scale(1.1); background: rgba(255,208,80,0.1); }
        .add-habit-fab:active { transform: scale(0.95); }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--padding-lg);
            animation: menuPop 0.15s ease;
        }
        .modal-overlay.hidden { display: none !important; }
        .modal-overlay .modal-content {
            background: var(--bg-secondary);
            border: var(--line-sm) solid var(--border);
            border-radius: var(--radius);
            padding: var(--padding-lg);
            width: 100%;
            max-width: calc(500px - 2 * var(--padding-lg));
        }

        /* Habit card states */
        .habit-card.state-completed {
            opacity: var(--disabled-opacity);
            cursor: default;
        }
        .habit-card.state-failed .habit-title, .habit-card.state-failed .streak-number { color: var(--danger); }

        /* Indicator states */
        .habit-indicator {
            flex-shrink: 0;
            width: var(--text-xl);
            height: var(--text-xl);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .red { color: var(--danger); }
        .accent { color: var(--accent-primary); }
        .indicator-svg { width: var(--text-xl); height: var(--text-xl); }
        .indicator-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--text-xs);
            font-weight: 400;
            color: var(--text-secondary);
            pointer-events: none;
        }
        .indicator-restart {
            color: var(--danger);
            width: var(--text-xl);
            height: var(--text-xl);
        }

        /* Debug button */
        .debug-next-day {
            position: fixed;
            bottom: calc(var(--button-height) + 12px);
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 50;
            display: none;
            line-height: 1.3;
            text-align: center;
        }
        .debug-next-day.visible { display: block; }
        .debug-next-day:hover { background: var(--border); }


        .type-btn {
            font-family: 'Fraunces', serif;
            font-size: var(--text-lg);
            font-weight: 600;
        }
        .type-btn.active {
            color: var(--accent-primary);
            background: transparent;
        }
        .type-btn:not(.active) {
            color: var(--text-secondary);
        }

        /* Delete confirmation modal */
        .delete-preview {
            margin-bottom: var(--padding-lg);
        }
        .delete-preview .habit-card {
            cursor: default;
            pointer-events: none;
            margin: 0;
        }
        .btn-modal-delete {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: #ff5050;
            color: #fff;
        }
        .btn-modal-delete:hover { background: #ff3333; }
    </style>
</head>
<body>
    <!-- Timer Page -->
    <div class="page active" id="timerPage">
        <h1>Timer</h1>

        <div class="input-row">
            <div class="input-group">
                <label>Cycle (minutes)</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="timerCycleMinus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <div class="stepper-value" id="timerCycleValue">10</div>
                    <button class="stepper-btn" id="timerCyclePlus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label>Divisions</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="timerDivMinus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <div class="stepper-value" id="timerDivValue">1</div>
                    <button class="stepper-btn" id="timerDivPlus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="input-group">
            <label>Sound Profile</label>
            <div class="stepper-wrapper">
                <button class="select-btn selected" id="soundProfileGong">Gong</button>
                <button class="select-btn" id="soundProfileBowl">Bowl</button>
            </div>
        </div>

        <div class="circular-timer">
            <div class="circle-container">
                <svg class="circle-svg" viewBox="0 0 200 200">
                    <!-- Segmented circles will be drawn by JS -->
                    <g id="circleSegments"></g>
                    <!-- Position marker -->
                    <circle class="position-marker" id="positionMarker" cx="100" cy="10" r="6"/>
                </svg>
                <div class="center-controls">
                    <button class="btn-primary" id="startBtn">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.5 6.47331C11 5.60749 13.0002 6.76264 17 9.07195L20 10.8034C23.9997 13.1126 25.9997 14.2678 26 15.9997C26 17.7317 23.9999 18.8866 20 21.196L17 22.9284C13.0001 25.2378 11 26.3921 9.5 25.526C8.00011 24.66 8 22.3508 8 17.7321V14.2682C8 9.64944 8 7.33934 9.5 6.47331Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-primary hidden" id="pauseBtn">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 6C12.6569 6 14 7.34315 14 9V23C14 24.6569 12.6569 26 11 26C9.34315 26 8 24.6569 8 23V9C8 7.34315 9.34315 6 11 6Z" fill="currentColor"/>
                            <path d="M21 6C22.6569 6 24 7.34315 24 9V23C24 24.6569 22.6569 26 21 26C19.3431 26 18 24.6569 18 23V9C18 7.34315 19.3431 6 21 6Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-secondary danger hidden" id="stopBtn">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 8C19.7712 8 21.6566 8.0003 22.8281 9.17188C23.9997 10.3434 24 12.2288 24 16C24 19.7712 23.9997 21.6566 22.8281 22.8281C21.6566 23.9997 19.7712 24 16 24C12.2288 24 10.3434 23.9997 9.17188 22.8281C8.0003 21.6566 8 19.7712 8 16C8 12.2288 8.0003 10.3434 9.17188 9.17188C10.3434 8.0003 12.2288 8 16 8Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-primary hidden" id="continueBtn">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.5 6.47331C11 5.60749 13.0002 6.76264 17 9.07195L20 10.8034C23.9997 13.1126 25.9997 14.2678 26 15.9997C26 17.7317 23.9999 18.8866 20 21.196L17 22.9284C13.0001 25.2378 11 26.3921 9.5 25.526C8.00011 24.66 8 22.3508 8 17.7321V14.2682C8 9.64944 8 7.33934 9.5 6.47331Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Habits Page -->
    <div class="page" id="habitsPage">
        <h1>Habits</h1>

        <div class="habits-list-and-button">
            <div id="habitsList" class="habits-list">
                <!-- Habits will be rendered here -->
            </div>

            <div class="empty-state hidden" id="emptyStateHabits">
                <h2>No habits yet</h2>
                <p>Start tracking your first habit</p>
            </div>
            
            <!-- <button class="add-habit-fab" id="addHabitBtn"> -->
            <button class="btn-tertiary wide" id="addHabitBtn">
                <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Add/Edit Habit Modal -->
    <div class="modal-overlay hidden" id="habitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h1 id="habitModalTitle">Add Habit</h1>
            </div>
            
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="habitName" placeholder="Read 20 pages" maxlength="50">
            </div>

            <div class="input-group">
                <label>Frequency</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="frequencyMinus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M24 14C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H24Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <div class="stepper-value" id="frequencyValue">10</div>
                    <button class="stepper-btn" id="frequencyPlus">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 6C17.1046 6 18 6.89543 18 8V14H24C25.1046 14 26 14.8954 26 16C26 17.1046 25.1046 18 24 18H18V24C18 25.1046 17.1046 26 16 26C14.8954 26 14 25.1046 14 24V18H8C6.89543 18 6 17.1046 6 16C6 14.8954 6.89543 14 8 14H14V8C14 6.89543 14.8954 6 16 6Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="input-group">
                <label>Type</label>
                <div class="stepper-wrapper">
                    <button class="select-btn selected" data-type="daily" id="dailyBtn">Daily</button>
                    <button class="select-btn" data-type="weekly" id="weeklyBtn">Weekly</button>
                </div>
            </div>

            <div class="actions">
                <button class="btn-tertiary wide" id="habitCancelBtn">Cancel</button>
                <button class="btn-primary wide" id="habitSaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Debug: Next Day Button -->
    <!-- <button class="debug-next-day visible" id="debugNextDayBtn">⏭ Next<br>Day</button> -->

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay hidden" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h1>Delete Item</h1>
            </div>
            <div id="deleteModalPreview" class="delete-preview"></div>
            <div class="actions">
                <button class="btn-tertiary wide" id="deleteCancelBtn">Cancel</button>
                <button class="btn-primary danger wide" id="deleteConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Context Menu for Long Press / Right Click -->
    <div class="context-menu hidden" id="contextMenu">
        <button class="context-menu-item" id="editHabitBtn">
            <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21.293 10.707C22.626 12.04 23.2925 12.7072 23.2927 13.5354V13.5354C23.2925 14.3637 22.626 15.0302 21.293 16.3632L10.8277 26.8285C10.2498 27.4064 9.96079 27.6954 9.59334 27.8476V27.8476C9.22587 27.9998 8.8169 27.9999 7.99957 27.9999C6.11437 27.9999 5.17177 27.9999 4.58602 27.4144V27.4144C4.00047 26.8286 4 25.8856 4 24.0004C4 23.183 4 22.7744 4.15218 22.4069V22.4069C4.30442 22.0395 4.59351 21.7502 5.17145 21.1722L15.6367 10.707C16.9698 9.37393 17.6363 8.70741 18.4645 8.70728V8.70728C19.2927 8.70741 19.9599 9.37393 21.293 10.707ZM6.53538 22.6355C6.19258 22.9783 6 23.4432 6 23.928V24.0002C6 25.1046 6.89533 25.9999 7.99979 25.9999H8.0708C8.55571 25.9999 9.02075 25.8073 9.36364 25.4644C10.0776 24.7505 10.0777 23.593 9.36386 22.879L9.12065 22.6357C8.40684 21.9216 7.24931 21.9215 6.53538 22.6355ZM27.1816 7.18158C27.3974 7.39732 27.5053 7.50519 27.5841 7.60752C28.1382 8.32687 28.1382 9.32927 27.5841 10.0486C27.5053 10.1509 27.3974 10.2588 27.1816 10.4746C26.9659 10.6903 26.858 10.7982 26.7557 10.877C26.0364 11.4311 25.034 11.4311 24.3146 10.877C24.2123 10.7982 24.1044 10.6903 23.8887 10.4746L21.5254 8.11127C21.3097 7.89553 21.2018 7.78766 21.1229 7.68533C20.5688 6.96598 20.5688 5.96359 21.1229 5.24424C21.2018 5.14191 21.3097 5.03404 21.5254 4.8183C21.7411 4.60256 21.849 4.49469 21.9513 4.41586C22.6707 3.86171 23.6731 3.86171 24.3924 4.41586C24.4947 4.49469 24.6026 4.60256 24.8184 4.8183L27.1816 7.18158Z" fill="currentColor"/>
            </svg>
            <span>Edit</span>
        </button>
        <button class="context-menu-item red" id="deleteHabitBtn">
            <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 5C18 5.55228 18.4477 6 19 6H24.5C25.3284 6 26 6.67157 26 7.5C26 8.32843 25.3284 9 24.5 9H7.5C6.67157 9 6 8.32843 6 7.5C6 6.67157 6.67157 6 7.5 6H13C13.5523 6 14 5.55228 14 5C14 4.44772 14.4477 4 15 4H17C17.5523 4 18 4.44772 18 5Z" fill="currentColor"/>
                <path d="M8.37367 17.3523C8.19843 14.3733 8.11081 12.8838 8.99894 11.9419C9.88707 11 11.3792 11 14.3633 11H17.6367C20.6209 11 22.1129 11 23.0011 11.9419C23.8892 12.8838 23.8016 14.3733 23.6263 17.3523L23.3322 22.3523C23.1748 25.0277 23.0962 26.3654 22.2294 27.1827C21.3626 28 20.0226 28 17.3426 28H14.6574C11.9774 28 10.6374 28 9.77062 27.1827C8.90385 26.3654 8.82516 25.0277 8.66778 22.3523L8.37367 17.3523Z" fill="currentColor"/>
            </svg>
            <span>Delete</span>
        </button>
    </div>

    <!-- Calm Down Page -->
    <div class="page" id="calmPage">
        <h1>Calm Down</h1>

        <div class="input-row">
            <div class="input-group">
                <label>Duration (seconds)</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="breathDurationMinus">−</button>
                    <div class="stepper-value" id="breathDurationValue">20</div>
                    <button class="stepper-btn" id="breathDurationPlus">+</button>
                </div>
            </div>
        </div>

        <div class="breath-container">
            <div class="breath-circle" id="breathCircle"></div>
            
            <div class="breath-content">
                <div class="breath-phase" id="breathPhase">Inhale</div>
                <div class="breath-dots" id="breathDots">
                    <!-- Dots will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="timerPage">
            <!-- <svg class="nav-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.5 15.5C12.3524 15.5 12.98 15.9095 13.5703 16.5518C13.8717 16.8796 14.1395 17.2418 14.418 17.6221C14.5829 17.8474 14.5829 18.1526 14.418 18.3779C14.1395 18.7582 13.8717 19.1204 13.5703 19.4482C12.98 20.0904 12.3524 20.5 11.5 20.5C10.1193 20.5 9.00007 19.3807 9 18C9 16.6193 10.1193 15.5 11.5 15.5Z" fill="currentColor"/>
                <path d="M20.5 15.5C21.8807 15.5 23 16.6193 23 18C22.9999 19.3807 21.8807 20.5 20.5 20.5C19.6476 20.5 19.02 20.0904 18.4297 19.4482C18.1283 19.1204 17.8605 18.7582 17.582 18.3779C17.4169 18.1524 17.4169 17.8476 17.582 17.6221C17.8605 17.2418 18.1283 16.8796 18.4297 16.5518C19.02 15.9095 19.6476 15.5 20.5 15.5Z" fill="currentColor"/>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M16 6C16.9282 6 17.3924 6.00032 17.7842 6.02832C19.4403 6.14677 20.9929 6.63048 22.3643 7.39746C22.4554 7.30138 22.5703 7.18748 22.7178 7.04004C23.0463 6.71153 23.2103 6.54693 23.374 6.4375C24.0466 5.98809 24.9241 5.98809 25.5967 6.4375C25.7604 6.54694 25.9245 6.71157 26.2529 7.04004L26.96 7.74707C27.2884 8.07552 27.4531 8.23959 27.5625 8.40332C28.0119 9.07592 28.0119 9.95338 27.5625 10.626C27.4531 10.7897 27.2885 10.9537 26.96 11.2822C26.8125 11.4297 26.6976 11.5436 26.6016 11.6348C27.3688 13.0061 27.8532 14.5585 27.9717 16.2148C27.9997 16.6067 28 17.0714 28 18C28 18.9282 27.9997 19.3924 27.9717 19.7842C27.5814 25.2406 23.2406 29.5814 17.7842 29.9717C17.3924 29.9997 16.9282 30 16 30C15.0714 30 14.6067 29.9997 14.2148 29.9717C8.75852 29.5813 4.41857 25.2405 4.02832 19.7842C4.00032 19.3924 4 18.9282 4 18C4 17.0714 4.00029 16.6067 4.02832 16.2148C4.41871 10.7586 8.75863 6.41869 14.2148 6.02832C14.6067 6.00029 15.0714 6 16 6ZM20.5 13.5C18.8673 13.5 17.7453 14.3406 16.957 15.1982C16.7865 15.3838 16.7009 15.4765 16.6621 15.5107C16.2273 15.8952 15.7727 15.8952 15.3379 15.5107C15.2991 15.4765 15.2135 15.3838 15.043 15.1982C14.2547 14.3406 13.1327 13.5 11.5 13.5C9.01472 13.5 7 15.5147 7 18C7.00007 20.4852 9.01476 22.5 11.5 22.5C13.1326 22.5 14.2547 21.6594 15.043 20.8018C15.2133 20.6164 15.2988 20.5238 15.3379 20.4893C15.7726 20.1051 16.2274 20.1051 16.6621 20.4893C16.7012 20.5238 16.7867 20.6164 16.957 20.8018C17.7453 21.6594 18.8674 22.5 20.5 22.5C22.9852 22.5 24.9999 20.4852 25 18C25 15.5147 22.9853 13.5 20.5 13.5Z" fill="currentColor"/>
                <path d="M19.5 2C20.3284 2 21 2.67157 21 3.5C21 4.32843 20.3284 5 19.5 5H12.5C11.6716 5 11 4.32843 11 3.5C11 2.67157 11.6716 2 12.5 2H19.5Z" fill="currentColor"/>
            </svg> -->
            <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M23.5 9.5C27.0899 9.5 30 12.4101 30 16C30 19.5899 27.0899 22.5 23.5 22.5C20.9095 22.5 18.939 21.2409 17.5605 19.9824C16.9412 19.417 16.4211 18.8317 16 18.3301C15.5789 18.8317 15.0588 19.417 14.4395 19.9824C13.061 21.2409 11.0905 22.5 8.5 22.5C4.91015 22.5 2 19.5899 2 16C2 12.4101 4.91015 9.5 8.5 9.5C11.0905 9.5 13.061 10.7591 14.4395 12.0176C15.0586 12.5828 15.579 13.1675 16 13.6689C16.421 13.1675 16.9414 12.5828 17.5605 12.0176C18.939 10.7591 20.9095 9.5 23.5 9.5ZM8.5 12.5C6.567 12.5 5 14.067 5 16C5 17.933 6.567 19.5 8.5 19.5C10.0516 19.5 11.331 18.759 12.417 17.7676C12.9576 17.2741 13.4243 16.7413 13.833 16.2471C13.898 16.1684 13.9652 16.085 14.0342 16C13.9652 15.915 13.898 15.8316 13.833 15.7529C13.4243 15.2587 12.9576 14.7259 12.417 14.2324C11.331 13.241 10.0516 12.5 8.5 12.5ZM23.5 12.5C21.9484 12.5 20.669 13.241 19.583 14.2324C19.0424 14.7259 18.5757 15.2587 18.167 15.7529C18.1018 15.8317 18.034 15.9148 17.9648 16C18.034 16.0852 18.1018 16.1683 18.167 16.2471C18.5757 16.7413 19.0424 17.2741 19.583 17.7676C20.669 18.759 21.9484 19.5 23.5 19.5C25.433 19.5 27 17.933 27 16C27 14.067 25.433 12.5 23.5 12.5Z" fill="currentColor"/>
            </svg>
            <span>Timer</span>
        </button>
        <button class="nav-item" data-page="habitsPage">
            <svg class="nav-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M25.4004 5C25.9579 5 26.2367 5.00042 26.4668 5.05566C27.1981 5.23123 27.7688 5.80191 27.9443 6.5332C27.9996 6.76332 28 7.04206 28 7.59961C28 9.8305 28.0002 10.9466 27.7793 11.8672C27.077 14.7924 24.7924 17.077 21.8672 17.7793C21.0033 17.9866 19.9677 17.9973 18 17.998V25C18 26.1046 17.1046 27 16 27C14.8954 27 14 26.1046 14 25V21.998C12.0323 21.9973 10.9967 21.9866 10.1328 21.7793C7.20762 21.077 4.92298 18.7924 4.2207 15.8672C3.99977 14.9466 4 13.8305 4 11.5996C4 11.0421 4.00042 10.7633 4.05566 10.5332C4.23123 9.80191 4.80191 9.23123 5.5332 9.05566C5.76332 9.00042 6.04206 9 6.59961 9C8.8305 9 9.94657 8.99977 10.8672 9.2207C12.5501 9.62473 14.0203 10.5533 15.0996 11.8252C15.13 11.5758 15.1689 11.3489 15.2207 11.1328C15.923 8.20762 18.2076 5.92298 21.1328 5.2207C22.0534 4.99977 23.1695 5 25.4004 5Z" fill="currentColor"/>
            </svg>
            <span>Habits</span>
        </button>
        <button class="nav-item" data-page="calmPage">
            <svg class="nav-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 18C18.5909 18 19.1758 18.1167 19.7217 18.3428C20.2676 18.5689 20.7638 18.9005 21.1816 19.3184C21.5995 19.7362 21.9311 20.2324 22.1572 20.7783C22.3833 21.3242 22.5 21.9091 22.5 22.5C22.5 23.0909 22.3833 23.6758 22.1572 24.2217C21.9311 24.7676 21.5995 25.2638 21.1816 25.6816C20.7638 26.0995 20.2676 26.4311 19.7217 26.6572C19.1758 26.8833 18.5909 27 18 27C17.1716 27 16.5 26.3284 16.5 25.5C16.5 24.6716 17.1716 24 18 24C18.197 24 18.3922 23.9611 18.5742 23.8857C18.7561 23.8104 18.9213 23.6998 19.0605 23.5605C19.1998 23.4213 19.3104 23.2561 19.3857 23.0742C19.4611 22.8922 19.5 22.697 19.5 22.5C19.5 22.303 19.4611 22.1078 19.3857 21.9258C19.3104 21.7439 19.1998 21.5787 19.0605 21.4395C18.9213 21.3002 18.7561 21.1896 18.5742 21.1143C18.3922 21.0389 18.197 21 18 21H5.5C4.67157 21 4 20.3284 4 19.5C4 18.6716 4.67157 18 5.5 18H18Z" fill="currentColor"/>
                <path d="M23.5 14C24.7856 14 26.0424 14.3815 27.1113 15.0957C28.1802 15.8099 29.0129 16.8251 29.5049 18.0127C29.9969 19.2004 30.1258 20.5077 29.875 21.7686C29.6241 23.0292 29.0056 24.1878 28.0967 25.0967C27.5109 25.6824 26.5604 25.6824 25.9746 25.0967C25.3888 24.5109 25.3888 23.5604 25.9746 22.9746C26.4641 22.4851 26.7976 21.8616 26.9326 21.1826C27.0676 20.5037 26.9983 19.7996 26.7334 19.1602C26.4685 18.5208 26.0198 17.9743 25.4443 17.5898C24.8688 17.2053 24.1922 17 23.5 17H3.5C2.67157 17 2 16.3284 2 15.5C2 14.6716 2.67157 14 3.5 14H23.5Z" fill="currentColor"/>
                <path d="M22 4C22.5909 4 23.1758 4.1167 23.7217 4.34277C24.2676 4.56892 24.7638 4.9005 25.1816 5.31836C25.5995 5.73622 25.9311 6.23235 26.1572 6.77832C26.3833 7.32421 26.5 7.90914 26.5 8.5C26.5 9.09086 26.3833 9.67579 26.1572 10.2217C25.9311 10.7676 25.5995 11.2638 25.1816 11.6816C24.7638 12.0995 24.2676 12.4311 23.7217 12.6572C23.1758 12.8833 22.5909 13 22 13H7.5C6.67157 13 6 12.3284 6 11.5C6 10.6716 6.67157 10 7.5 10H22C22.197 10 22.3922 9.96112 22.5742 9.88574C22.7561 9.81036 22.9213 9.69979 23.0605 9.56055C23.1998 9.42131 23.3104 9.25613 23.3857 9.07422C23.4611 8.89223 23.5 8.69698 23.5 8.5C23.5 8.30302 23.4611 8.10777 23.3857 7.92578C23.3104 7.74387 23.1998 7.57869 23.0605 7.43945C22.9213 7.30021 22.7561 7.18964 22.5742 7.11426C22.3922 7.03888 22.197 7 22 7C21.1716 7 20.5 6.32843 20.5 5.5C20.5 4.67157 21.1716 4 22 4Z" fill="currentColor"/>
            </svg>
            <span>Calm Down</span>
        </button>
    </nav>

    <!-- <div class="install-prompt" id="installPrompt">
        <span>Install Timer Bell as an app</span>
        <button class="btn-primary" id="installBtn">Install</button>
    </div> -->

    <script>
        // Audio Context for generating bell sounds
        let audioContext;
        let isRunning = false;
        let isPaused = false;
        // Calm down state (hoisted so saveSettings can reference it)
        let breathingCycleDuration = 20;
        let breathingInterval = null;
        let breathingPhaseTimeout = null;
        let startTime;
        let pausedTime = 0;
        let elapsedTime = 0;
        let timerInterval;
        let nextSecondaryTime;
        let nextMainTime;
        let mainCycleMs;
        let secondaryIntervalMs;
        let currentTimerCycleValue = 10;
        let currentTimerDivValue = 1;
        let currentSoundProfile = 0;

        const soundProfiles = [
            [() => playGong(432), () => playGong(339)],
            [() => playSingingBowl(216), () => playSingingBowl(170)]
        ];

        // Main cycle values: 1-10, then 15, 20, 25, 30...
        const mainCycleValues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        for (let i = 15; i <= 60; i += 5) {
            mainCycleValues.push(i);
        }

        // Secondary values: 1-10
        const timerDivValues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

        // DOM elements
        const timerCycleValue = document.getElementById('timerCycleValue');
        const timerCyclePlus = document.getElementById('timerCyclePlus');
        const timerCycleMinus = document.getElementById('timerCycleMinus');
        const timerDivValue = document.getElementById('timerDivValue');
        const timerDivPlus = document.getElementById('timerDivPlus');
        const timerDivMinus = document.getElementById('timerDivMinus');
        const soundProfileGong = document.getElementById('soundProfileGong');
        const soundProfileBowl = document.getElementById('soundProfileBowl');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const continueBtn = document.getElementById('continueBtn');
        const positionMarker = document.getElementById('positionMarker');
        const circleSegments = document.getElementById('circleSegments');
        const circleContainer = document.querySelector('.circle-container');

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');

        // ── Settings persistence ──────────────────────────────────────────────
        function saveSettings() {
            try {
                const s = {
                    timerCycle: currentTimerCycleValue,
                    timerDiv: currentTimerDivValue,
                    soundProfile: currentSoundProfile,
                    breathDuration: breathingCycleDuration,
                    activePage: document.querySelector('.page.active')?.id || 'timerPage'
                };
                store.set('app_settings', JSON.stringify(s));
            } catch(_) {}
        }

        async function loadSettings() {
            try {
                const val = await store.get('app_settings');
                if (!val) return;
                const s = JSON.parse(val);

                // Timer cycle
                if (mainCycleValues.includes(s.timerCycle)) {
                    currentTimerCycleValue = s.timerCycle;
                    timerCycleValue.textContent = currentTimerCycleValue;
                }
                // Timer divisions
                if (timerDivValues.includes(s.timerDiv)) {
                    currentTimerDivValue = s.timerDiv;
                    timerDivValue.textContent = currentTimerDivValue;
                }
                // Sound profile
                if (s.soundProfile === 0 || s.soundProfile === 1) {
                    currentSoundProfile = s.soundProfile;
                    updateSoundProfileButtons();
                }
                // Breath duration
                if (s.breathDuration >= 10 && s.breathDuration <= 60) {
                    breathingCycleDuration = s.breathDuration;
                    const bdv = document.getElementById('breathDurationValue');
                    if (bdv) bdv.textContent = breathingCycleDuration;
                }
                // Active page
                if (s.activePage) {
                    const targetPage = s.activePage;
                    pages.forEach(p => p.classList.remove('active'));
                    const pg = document.getElementById(targetPage);
                    if (pg) pg.classList.add('active');
                    navItems.forEach(nav => {
                        nav.classList.toggle('active', nav.dataset.page === targetPage);
                    });
                    // Start breathing if restoring to calm page
                    if (targetPage === 'calmPage') {
                        setTimeout(() => {
                            const bc = document.getElementById('breathCircle');
                            if (bc) { bc.style.width = '10px'; bc.style.height = '10px'; }
                            runBreathingCycle();
                        }, 100);
                    }
                }

                updateStepperButtons();
                drawCircleSegments();
            } catch(e) {
                console.error('Failed to load settings:', e);
            }
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetPage = item.dataset.page;
                
                // Update active states
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show target page
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(targetPage).classList.add('active');

                saveSettings();
            });
        });

        // Update stepper buttons state
        function updateStepperButtons() {
            const mainIndex = mainCycleValues.indexOf(currentTimerCycleValue);
            timerCycleMinus.disabled = mainIndex === 0 || isRunning || isPaused;
            timerCyclePlus.disabled = mainIndex === mainCycleValues.length - 1 || isRunning || isPaused;

            const secondaryIndex = timerDivValues.indexOf(currentTimerDivValue);
            timerDivMinus.disabled = secondaryIndex === 0 || isRunning || isPaused;
            timerDivPlus.disabled = secondaryIndex === timerDivValues.length - 1 || isRunning || isPaused;
        }

        // Main cycle stepper
        timerCyclePlus.addEventListener('click', () => {
            const currentIndex = mainCycleValues.indexOf(currentTimerCycleValue);
            if (currentIndex < mainCycleValues.length - 1) {
                currentTimerCycleValue = mainCycleValues[currentIndex + 1];
                timerCycleValue.textContent = currentTimerCycleValue;
                updateStepperButtons();
                saveSettings();
            }
        });

        timerCycleMinus.addEventListener('click', () => {
            const currentIndex = mainCycleValues.indexOf(currentTimerCycleValue);
            if (currentIndex > 0) {
                currentTimerCycleValue = mainCycleValues[currentIndex - 1];
                timerCycleValue.textContent = currentTimerCycleValue;
                updateStepperButtons();
                saveSettings();
            }
        });

        // Secondary cycle stepper
        timerDivPlus.addEventListener('click', () => {
            const currentIndex = timerDivValues.indexOf(currentTimerDivValue);
            if (currentIndex < timerDivValues.length - 1) {
                currentTimerDivValue = timerDivValues[currentIndex + 1];
                timerDivValue.textContent = currentTimerDivValue;
                updateStepperButtons();
                drawCircleSegments();
                saveSettings();
            }
        });

        timerDivMinus.addEventListener('click', () => {
            const currentIndex = timerDivValues.indexOf(currentTimerDivValue);
            if (currentIndex > 0) {
                currentTimerDivValue = timerDivValues[currentIndex - 1];
                timerDivValue.textContent = currentTimerDivValue;
                updateStepperButtons();
                drawCircleSegments();
                saveSettings();
            }
        });


        // Update sound profile buttons state
        function updateSoundProfileButtons() {
            soundProfileGong.disabled = isRunning || isPaused;
            soundProfileBowl.disabled = isRunning || isPaused;

            if (currentSoundProfile === 0) {
                soundProfileGong.classList.add("selected");
                soundProfileBowl.classList.remove("selected");
            }
            else if (currentSoundProfile === 1) {
                soundProfileGong.classList.remove("selected");
                soundProfileBowl.classList.add("selected");
            }
        }

        // Sound profiles
        soundProfileGong.addEventListener('click', () => {
            soundProfiles[0][0]();
            if (currentSoundProfile !== 0) {
                currentSoundProfile = 0;
                updateSoundProfileButtons();
                saveSettings();
            }
        });

        soundProfileBowl.addEventListener('click', () => {
            soundProfiles[1][0]();
            if (currentSoundProfile !== 1) {
                currentSoundProfile = 1;
                updateSoundProfileButtons();
                saveSettings();
            }
        });

        // Draw segmented circle arcs with gaps
        function drawCircleSegments() {
            circleSegments.innerHTML = '';
            const radius = 90;
            const centerX = 100;
            const centerY = 100;
            const gapAngle = 0.15; // Larger gap size in radians (about 8.6 degrees)
            
            for (let i = 0; i < currentTimerDivValue; i++) {
                const startAngle = (i / currentTimerDivValue) * 2 * Math.PI + gapAngle / 2;
                const endAngle = ((i + 1) / currentTimerDivValue) * 2 * Math.PI - gapAngle / 2;
                
                // Calculate arc path
                const startX = centerX + radius * Math.cos(startAngle);
                const startY = centerY + radius * Math.sin(startAngle);
                const endX = centerX + radius * Math.cos(endAngle);
                const endY = centerY + radius * Math.sin(endAngle);
                
                const largeArcFlag = (endAngle - startAngle) > Math.PI ? 1 : 0;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`;
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'circle-segment');
                
                circleSegments.appendChild(path);
            }
        }

        // Update position marker on circle
        function updatePositionMarker(progress) {
            const radius = 90;
            const centerX = 100;
            const centerY = 100;
            const angle = progress * 2 * Math.PI;
            
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            positionMarker.setAttribute('cx', x);
            positionMarker.setAttribute('cy', y);
        }

        // Initialize audio context on first user interaction
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playGong(baseFreq = 600) {
            initAudio();
            const now = audioContext.currentTime;

            const masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(0.0001, now); // start near zero
            masterGain.gain.linearRampToValueAtTime(0.5, now + 0.01); // 10ms fade-in
            masterGain.connect(audioContext.destination);

            const ratios = [1.0, 0.5, 1.41, 1.93, 2.57, 3.16, 4.07];

            ratios.forEach((r, i) => {
                const osc = audioContext.createOscillator();
                osc.type = "sine";

                const gain = audioContext.createGain();

                const freq = baseFreq * r;

                // Softer pitch glide
                osc.frequency.setValueAtTime(freq * 1.02, now);
                osc.frequency.exponentialRampToValueAtTime(freq, now + 0.04);

                // Independent decay
                const decay = 4 + Math.random() * 4;

                gain.gain.setValueAtTime(0.0001, now);
                gain.gain.linearRampToValueAtTime(0.4 / (i + 1), now + 0.06); // gentle attack
                gain.gain.exponentialRampToValueAtTime(0.0001, now + decay);

                osc.connect(gain);
                gain.connect(masterGain);

                osc.start(now);
                osc.stop(now + decay);

                // ---- subtle detuned shimmer ----
                const oscDetune = audioContext.createOscillator();
                oscDetune.type = "sine";
                oscDetune.frequency.setValueAtTime(freq * (1 + 0.005 * Math.random()), now);

                const gainDetune = audioContext.createGain();
                gainDetune.gain.setValueAtTime(0.15 / (i + 1), now);
                gainDetune.gain.exponentialRampToValueAtTime(0.0001, now + decay);

                oscDetune.connect(gainDetune);
                gainDetune.connect(masterGain);

                oscDetune.start(now);
                oscDetune.stop(now + decay);
            });
        }

        function playSingingBowl(baseFreq = 220) {
            initAudio();
            const now = audioContext.currentTime;

            const masterGain = audioContext.createGain();
            masterGain.gain.setValueAtTime(0.0001, now);
            masterGain.gain.linearRampToValueAtTime(0.6, now + 0.1); // slow bloom
            masterGain.connect(audioContext.destination);

            const modes = [
                { ratio: 1.0, amp: 1.0 },
                { ratio: 2.3, amp: 0.4 },
                { ratio: 3.8, amp: 0.25 },
                { ratio: 5.4, amp: 0.15 }
            ];

            modes.forEach((mode, i) => {
                const freq = baseFreq * mode.ratio;
                const decay = 6 + Math.random() * 3;

                // Main oscillator
                const osc = audioContext.createOscillator();
                osc.type = "sine";
                osc.frequency.setValueAtTime(freq, now);

                const gain = audioContext.createGain();
                gain.gain.setValueAtTime(0.0001, now);
                gain.gain.linearRampToValueAtTime(mode.amp * 0.5, now + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.0001, now + decay);

                osc.connect(gain);
                gain.connect(masterGain);

                osc.start(now);
                osc.stop(now + decay);

                // Detuned oscillator for slow beating
                const detuneOsc = audioContext.createOscillator();
                detuneOsc.type = "sine";
                detuneOsc.frequency.setValueAtTime(freq * 1.003, now);

                const detuneGain = audioContext.createGain();
                detuneGain.gain.setValueAtTime(0.0001, now);
                detuneGain.gain.linearRampToValueAtTime(mode.amp * 0.3, now + 0.2);
                detuneGain.gain.exponentialRampToValueAtTime(0.0001, now + decay);

                detuneOsc.connect(detuneGain);
                detuneGain.connect(masterGain);

                detuneOsc.start(now);
                detuneOsc.stop(now + decay);
            });

            // Very slow global shimmer (subtle amplitude LFO)
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();

            lfo.frequency.value = 0.2; // very slow
            lfoGain.gain.value = 0.05;

            lfo.connect(lfoGain);
            lfoGain.connect(masterGain.gain);

            lfo.start(now);
            lfo.stop(now + 10);
        }

        // Update display
        function updateDisplay() {
            const progress = (elapsedTime % mainCycleMs) / mainCycleMs;
            updatePositionMarker(progress);
        }

        // Check and play bells
        function checkBells() {
            const tolerance = 50;

            // Check if we're at a main cycle boundary
            const isAtMainCycle = Math.abs(elapsedTime - nextMainTime) < tolerance;
            
            // Check if we're at a secondary cycle boundary
            const isAtSecondaryCycle = Math.abs(elapsedTime - nextSecondaryTime) < tolerance;
            
            // Main cycle takes priority
            if (isAtMainCycle) {
                soundProfiles[currentSoundProfile][0]();
                nextMainTime += mainCycleMs;
                
                // If the current secondary time would coincide with this main bell,
                // skip to the next secondary interval
                if (isAtSecondaryCycle) {
                    nextSecondaryTime += secondaryIntervalMs;
                }
            }
            // Only play secondary if not at main cycle
            else if (isAtSecondaryCycle) {
                soundProfiles[currentSoundProfile][1]();
                nextSecondaryTime += secondaryIntervalMs;
            }
        }

        // Show/hide buttons
        function showButtons(...buttons) {
            [startBtn, pauseBtn, stopBtn, continueBtn].forEach(btn => btn.classList.add('hidden'));
            buttons.forEach(btn => btn.classList.remove('hidden'));
        }

        // Start timer
        function startTimer() {
            initAudio();

            mainCycleMs = currentTimerCycleValue * 60 * 1000;
            secondaryIntervalMs = mainCycleMs / currentTimerDivValue;

            isRunning = true;
            isPaused = false;
            startTime = Date.now();
            elapsedTime = 0;
            pausedTime = 0;
            nextMainTime = mainCycleMs;
            nextSecondaryTime = secondaryIntervalMs;

            updateStepperButtons();
            updateSoundProfileButtons();
            showButtons(pauseBtn);
            
            soundProfiles[currentSoundProfile][0]();

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
                checkBells();
            }, 50);
        }

        // Pause timer
        function pauseTimer() {
            isRunning = false;
            isPaused = true;
            pausedTime = elapsedTime;
            clearInterval(timerInterval);
            
            showButtons(stopBtn, continueBtn);
            updateStepperButtons();
            updateSoundProfileButtons();
        }

        // Continue timer
        function continueTimer() {
            isRunning = true;
            isPaused = false;
            startTime = Date.now() - pausedTime;
            
            showButtons(pauseBtn);
            updateStepperButtons();
            updateSoundProfileButtons();

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
                checkBells();
            }, 50);
        }

        // Stop timer
        function stopTimer() {
            isRunning = false;
            isPaused = false;
            elapsedTime = 0;
            pausedTime = 0;
            clearInterval(timerInterval);

            showButtons(startBtn);
            updateStepperButtons();
            updateSoundProfileButtons();
            
            updatePositionMarker(0);
        }

        // Event listeners
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        continueBtn.addEventListener('click', continueTimer);
        stopBtn.addEventListener('click', stopTimer);

        // Initialize
        updateStepperButtons();
        drawCircleSegments();
        updatePositionMarker(0);

        // ===== HABITS PAGE =====
        
        let habits = [];
        let editingHabitId = null;
        let frequencyValue = 1;
        let habitType = 'daily';
        let longPressTimer = null;
        let selectedHabitForMenu = null;
        
        // Debug: simulated date offset in days
        let debugDayOffset = 0;

        // DOM elements for Habits page
        const addHabitBtn = document.getElementById('addHabitBtn');
        const habitModal = document.getElementById('habitModal');
        const habitsList = document.getElementById('habitsList');
        const emptyStateHabits = document.getElementById('emptyStateHabits');
        const habitModalTitle = document.getElementById('habitModalTitle');
        const habitName = document.getElementById('habitName');
        const habitCancelBtn = document.getElementById('habitCancelBtn');
        const habitSaveBtn = document.getElementById('habitSaveBtn');
        const frequencyValueEl = document.getElementById('frequencyValue');
        const frequencyPlus = document.getElementById('frequencyPlus');
        const frequencyMinus = document.getElementById('frequencyMinus');
        const dailyBtn = document.getElementById('dailyBtn');
        const weeklyBtn = document.getElementById('weeklyBtn');
        const contextMenu = document.getElementById('contextMenu');
        const editHabitBtn = document.getElementById('editHabitBtn');
        const deleteHabitBtn = document.getElementById('deleteHabitBtn');
        // const debugNextDayBtn = document.getElementById('debugNextDayBtn');
        const deleteModal = document.getElementById('deleteModal');
        const deleteModalPreview = document.getElementById('deleteModalPreview');
        const deleteCancelBtn = document.getElementById('deleteCancelBtn');
        const deleteConfirmBtn = document.getElementById('deleteConfirmBtn');

        // ── Period helpers ────────────────────────────────────────────────────
        // All period keys are YYYY-MM-DD strings.
        // Daily  → the date itself.
        // Weekly → the Monday of that ISO week (Mon 00:00 – Sun 23:59).

        function getSimulatedDate() {
            const d = new Date();
            d.setDate(d.getDate() + debugDayOffset);
            return d;
        }

        /** Return YYYY-MM-DD for the Monday of a given Date */
        function getMondayOf(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay(); // 0=Sun … 6=Sat
            const diff = (day === 0) ? -6 : 1 - day; // shift to Monday
            d.setDate(d.getDate() + diff);
            return d.toISOString().split('T')[0];
        }

        /** Return the current period key for a habit */
        function getCurrentPeriodKey(habit) {
            const now = getSimulatedDate();
            if (habit.type === 'daily') {
                return now.toISOString().split('T')[0];
            } else {
                return getMondayOf(now);
            }
        }

        /** Return the previous period key for a habit */
        function getPreviousPeriodKey(habit) {
            const now = getSimulatedDate();
            if (habit.type === 'daily') {
                const d = new Date(now);
                d.setDate(d.getDate() - 1);
                return d.toISOString().split('T')[0];
            } else {
                const d = new Date(now);
                d.setDate(d.getDate() - 7);
                return getMondayOf(d);
            }
        }

        /** Are we at the very start of a new period (i.e. current key ≠ last recorded key)?
         *  Used to decide whether to check for a missed previous period. */
        function isNewPeriod(habit) {
            const currentKey = getCurrentPeriodKey(habit);
            // If there are no completions ever, we're trivially in a "new" period
            if (habit.completions.length === 0) return false;
            // If the most recent completion entry is NOT for the current period → new period
            const keys = habit.completions.map(c => c.date);
            return !keys.includes(currentKey);
        }

        // ── Core state helpers ────────────────────────────────────────────────

        /** Completions logged for the current period */
        function getCompletionsCurrent(habit) {
            const key = getCurrentPeriodKey(habit);
            const c = habit.completions.find(c => c.date === key);
            return c ? c.count : 0;
        }

        /** State machine: 'unchecked' | 'partial' | 'checked' | 'failed' */
        function getHabitState(habit) {
            if (habit.isFailed) return 'failed';
            const current = getCompletionsCurrent(habit);
            const total = habit.timesRequired;
            if (current >= total) return 'checked';
            if (current > 0) return 'partial';
            return 'unchecked';
        }

        /** Should this habit be marked failed right now?
         *  Condition: we've moved into a new period AND the previous period
         *  was not fully completed AND the habit has a history (streak > 0 or
         *  any prior completion exists). */
        function shouldMarkFailed(habit) {
            if (habit.isFailed) return false;
            // Brand new habit with no history → never fail on first check
            if (habit.streak === 0 && habit.completions.length === 0) return false;
            // Only relevant when we've crossed a period boundary
            if (!isNewPeriod(habit)) return false;

            const prevKey = getPreviousPeriodKey(habit);
            const prevComp = habit.completions.find(c => c.date === prevKey);
            const prevCompleted = prevComp && prevComp.count >= habit.timesRequired;
            return !prevCompleted;
        }

        /** Mark any habits that should now be in failed state */
        function checkAndMarkFailedHabits() {
            let changed = false;
            habits.forEach(habit => {
                if (shouldMarkFailed(habit)) {
                    habit.isFailed = true;
                    changed = true;
                }
            });
            if (changed) scheduleSave(); // fire-and-forget, render happens after loadHabits
        }

        // ── Storage adapter ───────────────────────────────────────────────────
        // Works in Claude (window.storage) and plain browser (localStorage)
        const store = {
            async get(key) {
                if (typeof window.storage !== 'undefined') {
                    try { const r = await window.storage.get(key, false); return r ? r.value : null; } catch(_) { return null; }
                } else {
                    return localStorage.getItem(key);
                }
            },
            set(key, value) {
                if (typeof window.storage !== 'undefined') {
                    window.storage.set(key, value, false).catch(() => {});
                } else {
                    try { localStorage.setItem(key, value); } catch(_) {}
                }
            }
        };

        async function loadHabits() {
            try {
                const val = await store.get('habits_v3');
                if (val) habits = JSON.parse(val);
            } catch (_) {
                habits = [];
            }
            checkAndMarkFailedHabits();
            renderHabits();
        }

        function saveHabits() {
            store.set('habits_v3', JSON.stringify(habits));
        }

        // Debounced save — coalesces rapid taps into one write
        let _saveTimer = null;
        function scheduleSave() {
            if (_saveTimer) clearTimeout(_saveTimer);
            _saveTimer = setTimeout(() => { _saveTimer = null; saveHabits(); }, 300);
        }

        // Render immediately, persist in background
        function saveAndRender() {
            renderHabits();
            scheduleSave();
        }

        // -- Rendering ---------------------------------------------------------

        function createIndicator(state, current, total) {
            if (state === 'failed') {
                return `
                    <div class="habit-indicator red">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.0107 2.35186C15.5366 2.42109 16.014 2.69666 16.3369 3.11748C16.6251 3.49316 16.7099 4.0681 16.7363 5.02471C18.6529 5.15323 20.5071 5.78194 22.1113 6.85381C23.9201 8.06246 25.3305 9.7805 26.1631 11.7903C26.9956 13.8003 27.2135 16.0131 26.7891 18.1468C26.3645 20.2803 25.3165 22.2404 23.7783 23.7786C22.24 25.3169 20.2792 26.3649 18.1455 26.7894C16.0119 27.2136 13.7998 26.9958 11.79 26.1634C9.78022 25.3308 8.06216 23.9204 6.85352 22.1116C5.64492 20.3028 5.00006 18.1757 5 16.0003C5 15.1719 5.67157 14.5003 6.5 14.5003C7.32843 14.5003 8 15.1719 8 16.0003C8.00006 17.5824 8.46964 19.1291 9.34863 20.4446C10.2276 21.7601 11.4768 22.7854 12.9385 23.3909C14.4002 23.9964 16.0088 24.1556 17.5605 23.847C19.1123 23.5383 20.5384 22.7763 21.6572 21.6575C22.776 20.5388 23.538 19.1126 23.8467 17.5608C24.1553 16.0092 23.996 14.4004 23.3906 12.9388C22.7851 11.4771 21.7598 10.2279 20.4443 9.34893C19.3332 8.6065 18.0573 8.15653 16.7344 8.03448C16.706 8.95551 16.6189 9.51427 16.3369 9.88213C16.014 10.303 15.5366 10.5785 15.0107 10.6478C14.3377 10.7362 13.5167 10.2626 11.875 9.31475C10.233 8.36676 9.41215 7.89217 9.15234 7.26494C8.94949 6.77497 8.9494 6.22462 9.15234 5.73467C9.41215 5.10747 10.2332 4.63376 11.875 3.68584C13.5167 2.73801 14.3377 2.26344 15.0107 2.35186Z" fill="currentColor"/>
                        </svg>
                    </div>`;
            }

            if (state === 'checked') {
                return `
                    <div class="habit-indicator accent">
                        <svg class="btn-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16 2C23.732 2 30 8.26804 30 16C30 23.732 23.732 30 16 30C8.26809 29.9999 2 23.7319 2 16C2.00003 8.2681 8.26811 2.00009 16 2ZM26.1924 10.8428C25.6067 10.2571 24.657 10.2571 24.0713 10.8428L15.9395 18.9746C14.6061 20.308 13.9398 20.9756 13.1113 20.9756C12.283 20.9756 11.6163 20.3087 10.2832 18.9756L8.51465 17.207C7.92891 16.6213 6.97929 16.6213 6.39355 17.207C5.80784 17.7927 5.8079 18.7424 6.39355 19.3281L10.2822 23.2178C11.8443 24.7798 14.3773 24.7797 15.9395 23.2178L26.1924 12.9639C26.7781 12.3781 26.7781 11.4285 26.1924 10.8428Z" fill="currentColor"/>
                        </svg>

                    </div>`;
            }

            // partial or unchecked — same SVG, just different fill amount
            const baseSize = 32;
            const lineThickness = 2;
            const radius = (baseSize - lineThickness) / 2;
            const circ = 2 * Math.PI * radius;
            const offset = circ - (current / total) * circ;
            const showArc = current > 0; // partial

            return `
                <div class="habit-indicator">
                    <svg class="indicator-svg" viewBox="0 0 ${baseSize} ${baseSize}" style="transform: rotate(-90deg)">
                        <circle cx="${baseSize / 2}" cy="${baseSize / 2}" r="${radius}" fill="none" stroke="var(--border)" stroke-width="${lineThickness}"/>
                        ${showArc ? `<circle cx="${baseSize / 2}" cy="${baseSize / 2}" r="${radius}" fill="none" stroke="var(--accent-primary)" stroke-width="${lineThickness}"
                                stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"/>` : ''}
                    </svg>
                    ${total > 1 ? '<div class="indicator-text">' + current + '/' + total + '</div>' : ""}
                </div>`;
        }

        function renderHabits() {
            if (habits.length === 0) {
                habitsList.innerHTML = '';
                emptyStateHabits.classList.remove('hidden');
                return;
            }
            emptyStateHabits.classList.add('hidden');

            const stateOrder = { unchecked: 0, partial: 0, failed: 1, checked: 2 };
            const sorted = [...habits].sort((a, b) =>
                stateOrder[getHabitState(a)] - stateOrder[getHabitState(b)]
            );

            habitsList.innerHTML = sorted.map(habit => {
                const state = getHabitState(habit);
                const current = getCompletionsCurrent(habit);
                const total = habit.timesRequired;
                const streakUnit = habit.type === 'daily' ? 'DAYS' : 'WEEKS';
                const metaText = total > 1
                    ? `${total}X / ${habit.type === 'daily' ? 'DAY' : 'WEEK'}`
                    : (habit.type === 'daily' ? 'DAILY' : 'WEEKLY');
                const stateClass = state === 'checked' ? 'state-completed' : state === 'failed' ? 'state-failed' : '';

                return `
                    <div class="habit-card ${stateClass}"
                         data-id="${habit.id}"
                         ontouchstart="handleTouchStart(event,'${habit.id}')"
                         ontouchend="handleTouchEnd(event)"
                         ontouchmove="handleTouchEnd(event)"
                         onmousedown="handleTouchStart(event,'${habit.id}')"
                         onmouseup="handleTouchEnd(event)"
                         onmouseleave="handleTouchEnd(event)"
                         oncontextmenu="handleContextMenu(event,'${habit.id}')"
                         onclick="handleHabitClick('${habit.id}')">
                        ${createIndicator(state, current, total)}
                        <div class="habit-info">
                            <div class="habit-title">${habit.name}</div>
                            <div class="habit-meta">${metaText}</div>
                        </div>
                        <div class="habit-streak">
                            <div class="streak-number">${habit.streak}</div>
                            <div class="streak-unit">${streakUnit}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        // ── Interaction handlers ──────────────────────────────────────────────

        /** Long-press on mobile (500 ms) → context menu */
        window.handleTouchStart = function(event, habitId) {
            selectedHabitForMenu = habitId;
            longPressTimer = setTimeout(() => {
                longPressTimer = null;
                const touch = event.touches ? event.touches[0] : event;
                showContextMenu(touch.clientX, touch.clientY);
            }, 500);
        };

        window.handleTouchEnd = function() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        };

        /** Right-click → context menu */
        window.handleContextMenu = function(event, habitId) {
            event.preventDefault();
            selectedHabitForMenu = habitId;
            showContextMenu(event.clientX, event.clientY);
        };

        /** Tap / click → progress or open edit for failed */
        window.handleHabitClick = function(habitId) {
            // Ignore if long-press just fired or context menu is open
            if (longPressTimer === null && contextMenu && !contextMenu.classList.contains('hidden')) return;
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            if (habit.isFailed) { openEditModal(habit, true); return; }
            if (getHabitState(habit) === 'checked') return; // completed: no tap action
            markHabit(habitId);
        };

        function showContextMenu(x, y) {
            // Position with viewport clamping
            contextMenu.classList.remove('hidden');
            const mw = contextMenu.offsetWidth || 170;
            const mh = contextMenu.offsetHeight || 110;
            const cx = Math.min(x, window.innerWidth - mw - 8);
            const cy = Math.min(y, window.innerHeight - mh - 8);
            contextMenu.style.left = `${Math.max(8, cx)}px`;
            contextMenu.style.top  = `${Math.max(8, cy)}px`;
            contextMenu.style.transform = '';
            setTimeout(() => document.addEventListener('click', closeContextMenu, { once: true }), 50);
        }

        function closeContextMenu() {
            contextMenu.classList.add('hidden');
        }

        // ── Mark habit ────────────────────────────────────────────────────────

        async function markHabit(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            const key = getCurrentPeriodKey(habit);
            let comp = habit.completions.find(c => c.date === key);
            if (comp) {
                comp.count++;
            } else {
                habit.completions.push({ date: key, count: 1 });
                comp = habit.completions[habit.completions.length - 1];
            }

            // Fully completed → increment streak, clear failed flag
            if (comp.count >= habit.timesRequired) {
                habit.streak = (habit.streak || 0) + 1;
                habit.isFailed = false;
            }

            saveAndRender();
        }

        // Open add modal

        function openAddModal() {
            editingHabitId = null;
            habitModalTitle.textContent = 'Add Habit';
            habitName.value = '';
            frequencyValue = 1;
            frequencyValueEl.textContent = '1';
            habitType = 'daily';
            dailyBtn.classList.add('active');
            weeklyBtn.classList.remove('active');
            habitModal.classList.remove('hidden');
            setTimeout(() => habitName.focus(), 100);
        }

        function openEditModal(habit, isReset) {
            editingHabitId = habit.id;
            habitModalTitle.textContent = isReset ? 'Reset Habit' : 'Edit Habit';
            habitName.value = habit.name;
            frequencyValue = habit.timesRequired;
            frequencyValueEl.textContent = habit.timesRequired;
            habitType = habit.type;
            dailyBtn.classList.toggle('active', habit.type === 'daily');
            weeklyBtn.classList.toggle('active', habit.type === 'weekly');
            habitModal.classList.remove('hidden');
        }

        // ── Event listeners ───────────────────────────────────────────────────

        if (addHabitBtn) addHabitBtn.addEventListener('click', openAddModal);

        if (habitCancelBtn) habitCancelBtn.addEventListener('click', () => habitModal.classList.add('hidden'));
        if (habitModal) habitModal.addEventListener('click', e => { if (e.target === habitModal) habitModal.classList.add('hidden'); });

        if (frequencyPlus)  frequencyPlus.addEventListener('click', () => { if (frequencyValue < 10) { frequencyValue++; frequencyValueEl.textContent = frequencyValue; } });
        if (frequencyMinus) frequencyMinus.addEventListener('click', () => { if (frequencyValue > 1)  { frequencyValue--; frequencyValueEl.textContent = frequencyValue; } });

        if (dailyBtn)  dailyBtn.addEventListener('click',  () => { habitType = 'daily';  dailyBtn.classList.add('selected');  weeklyBtn.classList.remove('selected'); });
        if (weeklyBtn) weeklyBtn.addEventListener('click', () => { habitType = 'weekly'; weeklyBtn.classList.add('selected'); dailyBtn.classList.remove('selected'); });

        if (habitSaveBtn) {
            habitSaveBtn.addEventListener('click', () => {
                const name = habitName.value.trim();
                if (!name) { habitName.focus(); return; }

                if (editingHabitId) {
                    const idx = habits.findIndex(h => h.id === editingHabitId);
                    if (idx !== -1) {
                        // Saving always fully resets the habit
                        habits[idx] = {
                            id: editingHabitId, name, type: habitType,
                            timesRequired: frequencyValue, completions: [],
                            streak: 0, isFailed: false
                        };
                    }
                } else {
                    habits.push({ id: Date.now().toString(), name, type: habitType, timesRequired: frequencyValue, completions: [], streak: 0, isFailed: false });
                }

                habitModal.classList.add('hidden');
                saveAndRender();
            });
        }

        if (editHabitBtn) {
            editHabitBtn.addEventListener('click', () => {
                const habit = habits.find(h => h.id === selectedHabitForMenu);
                if (habit) { openEditModal(habit, false); closeContextMenu(); }
            });
        }

        if (deleteHabitBtn) {
            deleteHabitBtn.addEventListener('click', () => {
                const habit = habits.find(h => h.id === selectedHabitForMenu);
                if (!habit) return;
                closeContextMenu();
                openDeleteModal(habit);
            });
        }

        function openDeleteModal(habit) {
            const state = getHabitState(habit);
            const current = getCompletionsCurrent(habit);
            const total = habit.timesRequired;
            const streakUnit = habit.type === 'daily' ? 'DAYS' : 'WEEKS';
            const metaText = total > 1
                ? `${total}X / ${habit.type === 'daily' ? 'DAY' : 'WEEK'}`
                : (habit.type === 'daily' ? 'DAILY' : 'WEEKLY');
            const stateClass = state === 'checked' ? 'state-completed' : state === 'failed' ? 'state-failed' : '';

            deleteModalPreview.innerHTML = `
                <div class="habit-card ${stateClass}" style="cursor:default;pointer-events:none;">
                    ${createIndicator(state, current, total)}
                    <div class="habit-info">
                        <div class="habit-title">${habit.name}</div>
                        <div class="habit-meta">${metaText}</div>
                    </div>
                    <div class="habit-streak">
                        <div class="streak-number">${habit.streak}</div>
                        <div class="streak-unit">${streakUnit}</div>
                    </div>
                </div>`;

            deleteConfirmBtn.dataset.habitId = habit.id;
            deleteModal.classList.remove('hidden');
        }

        if (deleteCancelBtn) {
            deleteCancelBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
        }
        if (deleteModal) {
            deleteModal.addEventListener('click', e => { if (e.target === deleteModal) deleteModal.classList.add('hidden'); });
        }
        if (deleteConfirmBtn) {
            deleteConfirmBtn.addEventListener('click', () => {
                const id = deleteConfirmBtn.dataset.habitId;
                habits = habits.filter(h => h.id !== id);
                deleteModal.classList.add('hidden');
                saveAndRender();
            });
        }

        // Debug: advance day

        // if (debugNextDayBtn) {
        //     debugNextDayBtn.addEventListener('click', () => {
        //         debugDayOffset++;
        //         const sim = getSimulatedDate();
        //         const dayName = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][sim.getDay()];
        //         debugNextDayBtn.innerHTML = `⏭ +${debugDayOffset}d<br>${dayName} ${sim.toLocaleDateString('en', {month:'short',day:'numeric'})}`;
        //         checkAndMarkFailedHabits();
        //         renderHabits();
        //     });
        // }

        // Init

        loadHabits();
        loadSettings();

        // ===== CALM DOWN PAGE (BREATHING) =====
        // (breathingCycleDuration/breathingInterval/breathingPhaseTimeout declared at top)

        // DOM elements for Calm Down page
        const breathDurationValue = document.getElementById('breathDurationValue');
        const breathDurationPlus = document.getElementById('breathDurationPlus');
        const breathDurationMinus = document.getElementById('breathDurationMinus');
        const breathCircle = document.getElementById('breathCircle');
        const breathPhase = document.getElementById('breathPhase');
        const breathDots = document.getElementById('breathDots');

        // Duration stepper
        if (breathDurationPlus) {
            breathDurationPlus.addEventListener('click', () => {
                if (breathingCycleDuration < 60) {
                    breathingCycleDuration++;
                    breathDurationValue.textContent = breathingCycleDuration;
                    saveSettings();
                }
            });
        }

        if (breathDurationMinus) {
            breathDurationMinus.addEventListener('click', () => {
                if (breathingCycleDuration > 10) {
                    breathingCycleDuration--;
                    breathDurationValue.textContent = breathingCycleDuration;
                    saveSettings();
                }
            });
        }

        // Create breathing dots
        function createBreathDots(count) {
            breathDots.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const dot = document.createElement('div');
                dot.className = 'breath-dot';
                dot.dataset.index = i;
                breathDots.appendChild(dot);
            }
        }

        // Animate breathing circle
        function animateBreathCircle(targetSize, duration) {
            const startSize = parseFloat(breathCircle.style.width) || 10;
            const startTime = performance.now();
            const maxSize = 300;
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / (duration * 1000), 1);
                
                const currentSize = startSize + (targetSize - startSize) * progress;
                breathCircle.style.width = `${currentSize}px`;
                breathCircle.style.height = `${currentSize}px`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            requestAnimationFrame(animate);
        }

        // Activate breathing dots sequentially
        function activateBreathDots(count, duration) {
            const dots = breathDots.querySelectorAll('.breath-dot');
            const intervalMs = (duration * 1000) / count;
            
            dots.forEach(dot => dot.classList.remove('active'));
            
            let currentDot = 0;
            const dotInterval = setInterval(() => {
                if (currentDot < dots.length) {
                    dots[currentDot].classList.add('active');
                    currentDot++;
                } else {
                    clearInterval(dotInterval);
                }
            }, intervalMs);
            
            return dotInterval;
        }

        // Run breathing cycle
        function runBreathingCycle() {
            // CHECK DURATION AT START OF CYCLE
            const cycleDuration = breathingCycleDuration;
            
            // Calculate unit duration from total cycle duration
            const totalUnits = 19; // 4 + 7 + 8
            const unitDuration = cycleDuration / totalUnits;
            
            let phase = 0;
            
            function nextPhase() {
                if (phase === 0) {
                    // Inhale: 4 units
                    breathPhase.textContent = 'Inhale';
                    createBreathDots(4);
                    animateBreathCircle(300, unitDuration * 4);
                    activateBreathDots(4, unitDuration * 4);
                    breathingPhaseTimeout = setTimeout(nextPhase, unitDuration * 4 * 1000);
                    phase = 1;
                } else if (phase === 1) {
                    // Hold: 7 units
                    breathPhase.textContent = 'Hold';
                    createBreathDots(7);
                    // Circle stays at max size
                    activateBreathDots(7, unitDuration * 7);
                    breathingPhaseTimeout = setTimeout(nextPhase, unitDuration * 7 * 1000);
                    phase = 2;
                } else if (phase === 2) {
                    // Exhale: 8 units
                    breathPhase.textContent = 'Exhale';
                    createBreathDots(8);
                    animateBreathCircle(10, unitDuration * 8);
                    activateBreathDots(8, unitDuration * 8);
                    breathingPhaseTimeout = setTimeout(() => {
                        // Start next cycle - will check duration again
                        runBreathingCycle();
                    }, unitDuration * 8 * 1000);
                }
            }
            
            // Start with inhale
            nextPhase();
        }

        // Start breathing when Calm Down page is opened
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetPage = item.dataset.page;
                
                // Stop breathing if leaving calm page
                if (targetPage !== 'calmPage') {
                    if (breathingPhaseTimeout) {
                        clearTimeout(breathingPhaseTimeout);
                        breathingPhaseTimeout = null;
                    }
                }
                
                // Start breathing if entering calm page
                if (targetPage === 'calmPage') {
                    setTimeout(() => {
                        breathCircle.style.width = '10px';
                        breathCircle.style.height = '10px';
                        runBreathingCycle();
                    }, 100);
                }
            });
        });

        // PWA installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
            }
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(() => {
                console.log('Service Worker registered');
            });
        }
    </script>
</body>
</html>
