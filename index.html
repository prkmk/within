<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="description" content="Within - A mindful toolkit for staying present: Loop, Path, and Breath">
    <title>Within</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%23ffd050'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%231a1a1a'/%3E%3Ccircle cx='90' cy='90' r='60' fill='%23ffd050'/%3E%3C/svg%3E">
    
    <!-- Apple-specific PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Within">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --accent-primary: #ffd050;
            --accent-secondary: #ff6b6b;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --border: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(255, 208, 80, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.05) 0%, transparent 50%);
        }

        .page {
            display: none;
            padding: 24px 20px;
            max-width: 500px;
            margin: 0 auto;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 300;
            font-style: italic;
            margin-bottom: 32px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .input-row {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        .input-group {
            flex: 1;
        }

        label {
            display: block;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stepper-wrapper {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 2px solid var(--border);
            overflow: hidden;
        }

        .stepper-btn {
            flex: 0 0 auto;
            width: 56px;
            height: 56px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 0;
            font-weight: 300;
        }

        .stepper-btn:hover:not(:disabled) {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .stepper-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .stepper-btn:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.3;
        }

        .stepper-value {
            flex: 1;
            text-align: center;
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 12px 16px;
            min-width: 60px;
        }

        .circular-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 32px 0;
            padding: 20px;
        }

        .circle-container {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .circle-svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .circle-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 3;
        }

        .circle-segment {
            fill: none;
            stroke: var(--accent-primary);
            stroke-width: 3;
            opacity: 0.8;
            stroke-linecap: round;
        }

        .position-marker {
            fill: var(--accent-secondary);
            transition: cx 0.1s linear, cy 0.1s linear;
        }

        .center-controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        button {
            font-family: 'IBM Plex Mono', monospace;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .btn-svg {
            width: 28px;
            height: 28px;
        }

        .btn-svg path {
            fill: currentColor;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: #ffdb70;
            transform: scale(1.05);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--accent-secondary);
            border: 2px solid var(--accent-secondary);
        }

        .btn-secondary:hover {
            background: var(--accent-secondary);
            color: var(--bg-primary);
            transform: scale(1.05);
        }

        .btn-secondary:active {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.625rem;
            letter-spacing: 0.1em;
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-icon path {
            transition: fill 0.2s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .pulse .circle-segment {
            animation: pulse 0.6s ease;
        }

        @media (max-width: 400px) {
            .circle-container {
                width: 240px;
                height: 240px;
            }

            .center-time {
                font-size: 2rem;
            }

            .stepper-value {
                font-size: 2rem;
            }

            h1 {
                font-size: 1.75rem;
            }
        }

        /* PWA install prompt */
        .install-prompt {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            transition: transform 0.3s ease;
            max-width: 90%;
        }

        .install-prompt.show {
            transform: translateX(-50%) translateY(0);
        }

        .install-prompt button {
            padding: 8px 16px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Loop Page (formerly Timer) -->
    <div class="page active" id="loopPage">
        <h1>Loop ∞</h1>

        <div class="input-row">
            <div class="input-group">
                <label>Cycle (minutes)</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="mainMinus">−</button>
                    <div class="stepper-value" id="mainValue">10</div>
                    <button class="stepper-btn" id="mainPlus">+</button>
                </div>
            </div>

            <div class="input-group">
                <label>Divisions</label>
                <div class="stepper-wrapper">
                    <button class="stepper-btn" id="secondaryMinus">−</button>
                    <div class="stepper-value" id="secondaryValue">1</div>
                    <button class="stepper-btn" id="secondaryPlus">+</button>
                </div>
            </div>
        </div>

        <div class="circular-timer">
            <div class="circle-container">
                <svg class="circle-svg" viewBox="0 0 200 200">
                    <!-- Segmented circles will be drawn by JS -->
                    <g id="circleSegments"></g>
                    <!-- Position marker -->
                    <circle class="position-marker" id="positionMarker" cx="100" cy="10" r="6"/>
                </svg>
                <div class="center-controls">
                    <button class="btn-icon btn-primary" id="startBtn">
                        <svg class="btn-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18.8906 12.846C18.5371 14.189 16.8667 15.138 13.5257 17.0361C10.296 18.8709 8.6812 19.7884 7.37983 19.4196C6.8418 19.2671 6.35159 18.9776 5.95624 18.5787C5 17.6139 5 15.7426 5 12C5 8.2574 5 6.3861 5.95624 5.42132C6.35159 5.02245 6.8418 4.73288 7.37983 4.58042C8.6812 4.21165 10.296 5.12907 13.5257 6.96393C16.8667 8.86197 18.5371 9.811 18.8906 11.154C19.0365 11.7084 19.0365 12.2916 18.8906 12.846Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-icon btn-primary hidden" id="pauseBtn">
                        <svg class="btn-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 6C2 4.11438 2 3.17157 2.58579 2.58579C3.17157 2 4.11438 2 6 2C7.88562 2 8.82843 2 9.41421 2.58579C10 3.17157 10 4.11438 10 6V18C10 19.8856 10 20.8284 9.41421 21.4142C8.82843 22 7.88562 22 6 22C4.11438 22 3.17157 22 2.58579 21.4142C2 20.8284 2 19.8856 2 18V6Z" fill="currentColor"/>
                            <path d="M14 6C14 4.11438 14 3.17157 14.5858 2.58579C15.1716 2 16.1144 2 18 2C19.8856 2 20.8284 2 21.4142 2.58579C22 3.17157 22 4.11438 22 6V18C22 19.8856 22 20.8284 21.4142 21.4142C20.8284 22 19.8856 22 18 22C16.1144 22 15.1716 22 14.5858 21.4142C14 20.8284 14 19.8856 14 18V6Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-icon btn-secondary hidden" id="stopBtn">
                        <svg class="btn-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C22 4.92893 22 7.28595 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <button class="btn-icon btn-primary hidden" id="continueBtn">
                        <svg class="btn-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18.8906 12.846C18.5371 14.189 16.8667 15.138 13.5257 17.0361C10.296 18.8709 8.6812 19.7884 7.37983 19.4196C6.8418 19.2671 6.35159 18.9776 5.95624 18.5787C5 17.6139 5 15.7426 5 12C5 8.2574 5 6.3861 5.95624 5.42132C6.35159 5.02245 6.8418 4.73288 7.37983 4.58042C8.6812 4.21165 10.296 5.12907 13.5257 6.96393C16.8667 8.86197 18.5371 9.811 18.8906 11.154C19.0365 11.7084 19.0365 12.2916 18.8906 12.846Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Path Page (formerly Habits) -->
    <div class="page" id="pathPage">
        <h1>Path</h1>
        <p style="color: var(--text-secondary); text-align: center; margin-top: 48px; font-style: italic;">
            Coming soon...
        </p>
    </div>

    <!-- Breath Page (new) -->
    <div class="page" id="breathPage">
        <h1>Breath</h1>
        <p style="color: var(--text-secondary); text-align: center; margin-top: 48px; font-style: italic;">
            4-7-8 breathing helper coming soon...
        </p>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="loopPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15.5 3.5C15.5 3.5 17 5.25 17 8C17 10.75 15.5 12.5 15.5 12.5M20 1C20 1 22 3.5 22 8C22 12.5 20 15 20 15M2 13V11C2 7.22876 2 5.34315 3.17157 4.17157C4.34315 3 6.22876 3 10 3H11.5C12.8978 3 14.6744 3 15.5 4M7.5 21H16.5C17.9045 21 18.6067 21 19.1111 20.6629C19.3295 20.5226 19.5226 20.3295 19.6629 20.1111C20 19.6067 20 18.9045 20 17.5C20 16.0955 20 15.3933 19.6629 14.8889C19.5226 14.6705 19.3295 14.4774 19.1111 14.3371C18.6067 14 17.9045 14 16.5 14H7.5C6.09554 14 5.39331 14 4.88886 14.3371C4.67048 14.4774 4.47738 14.6705 4.33706 14.8889C4 15.3933 4 16.0955 4 17.5C4 18.9045 4 19.6067 4.33706 20.1111C4.47738 20.3295 4.67048 20.5226 4.88886 20.6629C5.39331 21 6.09554 21 7.5 21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Loop</span>
        </button>
        <button class="nav-item" data-page="pathPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2C14 2 14 3.5 16 4.5C18.5 5.5 19 7.5 19 7.5M18 9.5C18 9.5 18.5 11 19.5 12C21 13 22 14 22 14M2 12C2 7.52166 2 5.28249 3.39124 3.89124C4.78249 2.5 7.02166 2.5 11.5 2.5C15.9783 2.5 18.2175 2.5 19.6088 3.89124C21 5.28249 21 7.52166 21 12C21 16.4783 21 18.7175 19.6088 20.1088C18.2175 21.5 15.9783 21.5 11.5 21.5C7.02166 21.5 4.78249 21.5 3.39124 20.1088C2 18.7175 2 16.4783 2 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 8L12 16M12 16L15 13M12 16L9 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Path</span>
        </button>
        <button class="nav-item" data-page="breathPage">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3.35288 8.94202C2.48958 6.58312 3.53749 4.8369 5.21865 4.12818C6.39606 3.63904 7.80667 4.23668 8.9941 5.42403C9.44852 5.87846 9.92455 6.35448 10.4 6.8301M20.6471 8.94202C21.5104 6.58312 20.4625 4.8369 18.7814 4.12818C17.6039 3.63904 16.1933 4.23668 15.0059 5.42403C14.5515 5.87846 14.0754 6.35448 13.6 6.8301M13.6 6.8301C11.4802 8.94993 9.91977 8.94993 7.8 6.8301L7.23431 7.39578C6.29923 8.33086 5.83169 8.79841 5.51894 9.35549C5.20619 9.91256 5.06562 10.5368 4.78448 11.7854C4.11588 14.7044 3.78158 16.1639 4.59926 17.082C5.41694 18 6.91369 18 9.90718 18H14.0928C17.0863 18 18.5831 18 19.4007 17.082C20.2184 16.1639 19.8841 14.7044 19.2155 11.7854C18.9344 10.5368 18.7938 9.91256 18.4811 9.35549C18.1683 8.79841 17.7008 8.33086 16.7657 7.39578L16.2 6.8301C15.2 7.8301 14.4 8.0301 13.6 6.8301Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 14C10 14 10.5 14.5 12 14.5C13.5 14.5 14 14 14 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Breath</span>
        </button>
    </nav>

    <div class="install-prompt" id="installPrompt">
        <span>Install Timer Bell as an app</span>
        <button class="btn-primary" id="installBtn">Install</button>
    </div>

    <script>
        // Audio Context for generating bell sounds
        let audioContext;
        let isRunning = false;
        let isPaused = false;
        let startTime;
        let pausedTime = 0;
        let elapsedTime = 0;
        let timerInterval;
        let nextSecondaryTime;
        let nextMainTime;
        let mainCycleMs;
        let secondaryIntervalMs;
        let currentMainValue = 10;
        let currentSecondaryValue = 1;

        // Main cycle values: 1-10, then 15, 20, 25, 30...
        const mainCycleValues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        for (let i = 15; i <= 60; i += 5) {
            mainCycleValues.push(i);
        }

        // Secondary values: 1-10
        const secondaryValues = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

        // DOM elements
        const mainValue = document.getElementById('mainValue');
        const mainPlus = document.getElementById('mainPlus');
        const mainMinus = document.getElementById('mainMinus');
        const secondaryValue = document.getElementById('secondaryValue');
        const secondaryPlus = document.getElementById('secondaryPlus');
        const secondaryMinus = document.getElementById('secondaryMinus');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const continueBtn = document.getElementById('continueBtn');
        const positionMarker = document.getElementById('positionMarker');
        const circleSegments = document.getElementById('circleSegments');
        const circleContainer = document.querySelector('.circle-container');

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetPage = item.dataset.page;
                
                // Update active states
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show target page
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(targetPage).classList.add('active');
            });
        });

        // Update stepper buttons state
        function updateStepperButtons() {
            const mainIndex = mainCycleValues.indexOf(currentMainValue);
            mainMinus.disabled = mainIndex === 0 || isRunning || isPaused;
            mainPlus.disabled = mainIndex === mainCycleValues.length - 1 || isRunning || isPaused;

            const secondaryIndex = secondaryValues.indexOf(currentSecondaryValue);
            secondaryMinus.disabled = secondaryIndex === 0 || isRunning || isPaused;
            secondaryPlus.disabled = secondaryIndex === secondaryValues.length - 1 || isRunning || isPaused;
        }

        // Main cycle stepper
        mainPlus.addEventListener('click', () => {
            const currentIndex = mainCycleValues.indexOf(currentMainValue);
            if (currentIndex < mainCycleValues.length - 1) {
                currentMainValue = mainCycleValues[currentIndex + 1];
                mainValue.textContent = currentMainValue;
                updateStepperButtons();
            }
        });

        mainMinus.addEventListener('click', () => {
            const currentIndex = mainCycleValues.indexOf(currentMainValue);
            if (currentIndex > 0) {
                currentMainValue = mainCycleValues[currentIndex - 1];
                mainValue.textContent = currentMainValue;
                updateStepperButtons();
            }
        });

        // Secondary cycle stepper
        secondaryPlus.addEventListener('click', () => {
            const currentIndex = secondaryValues.indexOf(currentSecondaryValue);
            if (currentIndex < secondaryValues.length - 1) {
                currentSecondaryValue = secondaryValues[currentIndex + 1];
                secondaryValue.textContent = currentSecondaryValue;
                updateStepperButtons();
                drawCircleSegments();
            }
        });

        secondaryMinus.addEventListener('click', () => {
            const currentIndex = secondaryValues.indexOf(currentSecondaryValue);
            if (currentIndex > 0) {
                currentSecondaryValue = secondaryValues[currentIndex - 1];
                secondaryValue.textContent = currentSecondaryValue;
                updateStepperButtons();
                drawCircleSegments();
            }
        });

        // Draw segmented circle arcs with gaps
        function drawCircleSegments() {
            circleSegments.innerHTML = '';
            const radius = 90;
            const centerX = 100;
            const centerY = 100;
            const gapAngle = 0.15; // Larger gap size in radians (about 8.6 degrees)
            
            for (let i = 0; i < currentSecondaryValue; i++) {
                const startAngle = (i / currentSecondaryValue) * 2 * Math.PI + gapAngle / 2;
                const endAngle = ((i + 1) / currentSecondaryValue) * 2 * Math.PI - gapAngle / 2;
                
                // Calculate arc path
                const startX = centerX + radius * Math.cos(startAngle);
                const startY = centerY + radius * Math.sin(startAngle);
                const endX = centerX + radius * Math.cos(endAngle);
                const endY = centerY + radius * Math.sin(endAngle);
                
                const largeArcFlag = (endAngle - startAngle) > Math.PI ? 1 : 0;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M ${startX} ${startY} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`;
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'circle-segment');
                
                circleSegments.appendChild(path);
            }
        }

        // Update position marker on circle
        function updatePositionMarker(progress) {
            const radius = 90;
            const centerX = 100;
            const centerY = 100;
            const angle = progress * 2 * Math.PI;
            
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            
            positionMarker.setAttribute('cx', x);
            positionMarker.setAttribute('cy', y);
        }

        // Initialize audio context on first user interaction
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play high bell sound (main cycle)
        function playHighBell() {
            initAudio();
            const now = audioContext.currentTime;
            
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            osc1.frequency.setValueAtTime(880, now); // A5
            osc2.frequency.setValueAtTime(1320, now); // E6
            osc3.frequency.setValueAtTime(1760, now); // A6
            
            osc1.type = 'sine';
            osc2.type = 'sine';
            osc3.type = 'sine';
            
            osc1.connect(gainNode);
            osc2.connect(gainNode);
            osc3.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
            
            osc1.start(now);
            osc2.start(now);
            osc3.start(now);
            osc1.stop(now + 1.5);
            osc2.stop(now + 1.5);
            osc3.stop(now + 1.5);

            circleContainer.classList.add('pulse');
            setTimeout(() => circleContainer.classList.remove('pulse'), 600);
        }

        // Play low bell sound (secondary cycle)
        function playLowBell() {
            initAudio();
            const now = audioContext.currentTime;
            
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            osc1.frequency.setValueAtTime(440, now); // A4
            osc2.frequency.setValueAtTime(660, now); // E5
            
            osc1.type = 'sine';
            osc2.type = 'sine';
            
            osc1.connect(gainNode);
            osc2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 1.0);
            
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + 1.0);
            osc2.stop(now + 1.0);

            circleContainer.classList.add('pulse');
            setTimeout(() => circleContainer.classList.remove('pulse'), 600);
        }

        // Update display
        function updateDisplay() {
            const progress = (elapsedTime % mainCycleMs) / mainCycleMs;
            updatePositionMarker(progress);
        }

        // Check and play bells
        function checkBells() {
            const tolerance = 50;

            // Check if we're at a main cycle boundary
            const isAtMainCycle = Math.abs(elapsedTime - nextMainTime) < tolerance;
            
            // Check if we're at a secondary cycle boundary
            const isAtSecondaryCycle = Math.abs(elapsedTime - nextSecondaryTime) < tolerance;
            
            // Main cycle takes priority
            if (isAtMainCycle) {
                playHighBell();
                nextMainTime += mainCycleMs;
                
                // If the current secondary time would coincide with this main bell,
                // skip to the next secondary interval
                if (isAtSecondaryCycle) {
                    nextSecondaryTime += secondaryIntervalMs;
                }
            }
            // Only play secondary if not at main cycle
            else if (isAtSecondaryCycle) {
                playLowBell();
                nextSecondaryTime += secondaryIntervalMs;
            }
        }

        // Show/hide buttons
        function showButtons(...buttons) {
            [startBtn, pauseBtn, stopBtn, continueBtn].forEach(btn => btn.classList.add('hidden'));
            buttons.forEach(btn => btn.classList.remove('hidden'));
        }

        // Start timer
        function startTimer() {
            initAudio();

            mainCycleMs = currentMainValue * 60 * 1000;
            secondaryIntervalMs = mainCycleMs / currentSecondaryValue;

            isRunning = true;
            isPaused = false;
            startTime = Date.now();
            elapsedTime = 0;
            pausedTime = 0;
            nextMainTime = mainCycleMs;
            nextSecondaryTime = secondaryIntervalMs;

            updateStepperButtons();
            showButtons(pauseBtn);
            
            playHighBell();

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
                checkBells();
            }, 50);
        }

        // Pause timer
        function pauseTimer() {
            isRunning = false;
            isPaused = true;
            pausedTime = elapsedTime;
            clearInterval(timerInterval);
            
            showButtons(stopBtn, continueBtn);
            updateStepperButtons();
        }

        // Continue timer
        function continueTimer() {
            isRunning = true;
            isPaused = false;
            startTime = Date.now() - pausedTime;
            
            showButtons(pauseBtn);
            updateStepperButtons();

            timerInterval = setInterval(() => {
                elapsedTime = Date.now() - startTime;
                updateDisplay();
                checkBells();
            }, 50);
        }

        // Stop timer
        function stopTimer() {
            isRunning = false;
            isPaused = false;
            elapsedTime = 0;
            pausedTime = 0;
            clearInterval(timerInterval);

            showButtons(startBtn);
            updateStepperButtons();
            
            updatePositionMarker(0);
        }

        // Event listeners
        startBtn.addEventListener('click', startTimer);
        pauseBtn.addEventListener('click', pauseTimer);
        continueBtn.addEventListener('click', continueTimer);
        stopBtn.addEventListener('click', stopTimer);

        // Initialize
        updateStepperButtons();
        drawCircleSegments();
        updatePositionMarker(0);

        // PWA installation
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
            }
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });

                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl).then(() => {
                console.log('Service Worker registered');
            });
        }
    </script>
</body>
</html>
